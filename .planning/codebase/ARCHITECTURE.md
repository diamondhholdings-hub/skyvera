# Architecture

**Analysis Date:** 2026-02-08

## Pattern Overview

**Overall:** Multi-tier data pipeline with Python backend generating static HTML dashboards

**Key Characteristics:**
- Python scripts extract/transform revenue data from Excel source into JSON datasets
- Static HTML5/CSS3/JavaScript dashboards serve as end-user interface (no server required)
- Multi-business unit (BU) structure with separate but parallel processing pipelines
- Template-based HTML generation with embedded JavaScript for interactivity
- AI-generated customer intelligence reports provide strategic content

## Layers

**Data Layer:**
- Purpose: Extract and prepare customer/revenue data from Excel workbook
- Location: `scripts/` (extraction), `data/` (storage)
- Contains: Python scripts reading openpyxl Excel workbooks, JSON data files
- Depends on: Excel source file (`2025-12-11 Skyvera - Budget - Q1'26 - For Todd.xlsx`)
- Used by: Transformation/intelligence layers

**Transformation & Intelligence Layer:**
- Purpose: Generate customer intelligence reports (AI-powered) and parse them into structured data
- Location: `scripts/`, `data/intelligence/` (reports and prompts)
- Contains: Customer intelligence prompt generators, markdown intelligence reports, news fetchers
- Depends on: Customer data from Data Layer, AI agents for report generation
- Used by: Dashboard generation layer

**Dashboard Generation Layer:**
- Purpose: Transform customer data + intelligence into interactive HTML dashboards
- Location: `scripts/`, `templates/`
- Contains: Dashboard generators for each BU, HTML template system with JavaScript
- Depends on: Data Layer, Transformation Layer outputs
- Used by: End-user layer

**End-User Layer:**
- Purpose: Provide interactive web interface for account planning and analysis
- Location: `output/` (generated dashboards)
- Contains: Standalone HTML files with embedded CSS/JavaScript, customer-specific dashboards
- Depends on: Dashboard Generation Layer
- Accessed by: Web browser (no server required)

## Data Flow

**Full Intelligence Report Pipeline:**

1. Extract customer revenue data from Excel (`RR Input`, `NRR Input` sheets) → Customer JSON files (`data/customers_*.json`)
2. Generate intelligence prompts for each customer from revenue/rank data (`scripts/generate_customer_intelligence.py`)
3. AI agent processes prompts and generates markdown intelligence reports → `data/intelligence/reports/*.md`
4. Fetch news/OSINT for customers from Google News API → `data/news/*.json`
5. Parse intelligence reports to extract specific sections (Executives, Org Structure, etc.) → Intermediate JSON
6. Generate tabbed HTML dashboards embedding parsed intelligence → `output/*.html`

**State Management:**
- Stateless: All data is derived from Excel source, can be regenerated at any time
- Single source of truth: `2025-12-11 Skyvera - Budget - Q1'26 - For Todd.xlsx`
- Customer intelligence cached in JSON (hydration point for dashboard generation)
- Dashboard state stored in browser (no backend persistence)

## Key Abstractions

**Customer Record:**
- Purpose: Unified representation of customer financial and strategic data
- Examples: `data/customers_cloudsense_all.json`, `data/customers_kandy_all.json`
- Pattern: JSON structure with top-level `customers` array, each customer contains: `customer_name`, `rr`, `nrr`, `total`, `rank`, `pct_of_total`, `subscriptions` array

**Subscription Record:**
- Purpose: Tracks individual subscription ARR, renewal status, and projection
- Part of: Customer record's `subscriptions` array
- Fields: `sub_id`, `arr`, `renewal_qtr`, `will_renew`, `projected_arr`

**Intelligence Report:**
- Purpose: Comprehensive strategic analysis for account planning
- Format: Markdown with structured sections (Executive Summary, Company Intelligence, Key Findings, etc.)
- Location: `data/intelligence/reports/{customer_name}.md`
- Generated by: AI agents processing customer intelligence prompts

**Dashboard Template:**
- Purpose: Reusable HTML structure with placeholder variables for customer-specific content
- Location: `templates/account_plan_base.html`
- Contains: Tabbed interface structure, Chart.js configuration, embedded CSS/JavaScript
- Variables substituted: Customer name, revenue metrics, intelligence sections, executive data

**Business Unit Dataset:**
- Purpose: Isolate customer/revenue data by business unit for parallel processing
- Pattern: One JSON file per BU (`customers_cloudsense_all.json`, `customers_kandy_all.json`, etc.)
- Used by: BU-specific dashboard generators and index pages

## Entry Points

**Data Extraction:**
- Location: `scripts/extract_all_customers.py`, `scripts/extract_kandy_customers.py`, etc.
- Triggers: Manual execution or scheduled runs
- Responsibilities: Read Excel, validate data, write JSON customer files

**Intelligence Report Generation:**
- Location: `scripts/generate_customer_intelligence.py`, `scripts/generate_intelligence_prompts_all_bus.py`
- Triggers: Manual execution (triggers AI agents via external task tool)
- Responsibilities: Create prompts, invoke AI agents, store markdown reports

**Dashboard Generation:**
- Location: `scripts/generate_tabbed_dashboards.py`, `scripts/create_full_dashboard.py`
- Triggers: Manual execution or after intelligence reports generated
- Responsibilities: Load customer data + intelligence, render HTML, write to output directory

**News Fetching:**
- Location: `scripts/fetch_customer_news.py`, `scripts/daily_news_update.sh`
- Triggers: Manual execution or daily scheduled job
- Responsibilities: Query news APIs, rank by relevance, save JSON per customer

**Index Generation:**
- Location: `scripts/generate_index.py`, `scripts/generate_index_kandy.py`, etc.
- Triggers: Manual execution after dashboard generation
- Responsibilities: Create master landing page with dropdown customer selector

## Error Handling

**Strategy:** Graceful degradation with fallback mechanisms

**Patterns:**
- File not found: Skip loading that data, continue with defaults (e.g., if intelligence report missing, show empty tab)
- Excel parsing errors: Try/except blocks with silent continuation, skip malformed rows
- Missing intelligence sections: Return None, dashboard shows "Data not available" placeholder
- News API failures: Log warning, continue without news widget
- Customer name matching: Try exact match first, then partial/fuzzy matching (handles filename encoding differences)

## Cross-Cutting Concerns

**Logging:**
- Print statements in Python scripts for progress tracking
- Example: `print(f"✅ Generated dashboard for {customer_name}")`, `print(f"⚠ Google News fetch failed: {e}")`

**Validation:**
- Excel data: Check BU name, customer name, revenue values are non-null/positive
- Customer names: Normalize with `.replace('/', '-').replace(' ', '_')` for safe filename generation
- Revenue data: Filter out zero-value subscriptions, verify ARR > 0 before including in rankings

**Metadata Tracking:**
- Report generation timestamps: `datetime.now()` for "last_updated" in JSON
- Customer rankings: Based on total revenue (RR + NRR), updated per Excel data refresh
- Excel column mapping: Hard-coded indices (e.g., row[0]=BU, row[1]=customer_name) — fragile, depends on specific Excel layout

---

*Architecture analysis: 2026-02-08*
