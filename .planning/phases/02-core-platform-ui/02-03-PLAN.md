---
phase: 02-core-platform-ui
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/app/accounts/page.tsx
  - src/app/accounts/components/account-table.tsx
  - src/app/accounts/components/account-filters.tsx
  - src/app/accounts/components/account-stats.tsx
  - src/app/alerts/page.tsx
  - src/app/alerts/components/alert-list.tsx
  - src/app/alerts/components/alert-summary.tsx
autonomous: true

must_haves:
  truths:
    - "User browses all 140 customers in a sortable, searchable table"
    - "User filters customers by business unit (Cloudsense, Kandy, STL)"
    - "User sees health score indicator (red/yellow/green with icon and text) for each customer"
    - "User sees financial metrics per customer (ARR, NRR, total revenue) with freshness timestamp"
    - "User views alerts dashboard with at-risk accounts sorted by severity"
    - "User sees summary counts of alerts by severity at top of alerts page"
  artifacts:
    - path: "src/app/accounts/page.tsx"
      provides: "Account directory Server Component fetching 140 customers with health"
      min_lines: 20
    - path: "src/app/accounts/components/account-table.tsx"
      provides: "TanStack Table with sorting, filtering, search for customer list"
      min_lines: 60
    - path: "src/app/alerts/page.tsx"
      provides: "Alerts dashboard showing at-risk accounts and metric anomalies"
      min_lines: 20
    - path: "src/app/alerts/components/alert-list.tsx"
      provides: "Alert cards with severity indicators, descriptions, and affected accounts"
      min_lines: 40
  key_links:
    - from: "src/app/accounts/page.tsx"
      to: "src/lib/data/server/account-data.ts"
      via: "getAllCustomersWithHealth() call in Server Component"
      pattern: "getAllCustomersWithHealth"
    - from: "src/app/accounts/components/account-table.tsx"
      to: "@tanstack/react-table"
      via: "useReactTable with sorting, filtering, global search"
      pattern: "useReactTable|getCoreRowModel|getSortedRowModel|getFilteredRowModel"
    - from: "src/app/alerts/page.tsx"
      to: "src/lib/data/server/alert-data.ts"
      via: "getProactiveAlerts() call in Server Component"
      pattern: "getProactiveAlerts"
    - from: "src/app/accounts/components/account-table.tsx"
      to: "src/components/ui/health-indicator.tsx"
      via: "HealthIndicator rendered in health column cell"
      pattern: "HealthIndicator"
---

<objective>
Build the customer account directory with search, filtering, and health scoring, plus the proactive alerts dashboard showing at-risk accounts and metric anomalies.

Purpose: Account managers need to browse all 140 customers, search by name, filter by BU, and quickly identify health status (ACCT-01, ACCT-02, ACCT-03). Executives need a proactive alerts view showing at-risk accounts and financial anomalies requiring attention (DASH-02).

Output: Working /accounts route with TanStack Table (sortable, searchable, filterable) showing all customers with health indicators and financial metrics. Working /alerts route showing severity-sorted alerts with summary statistics.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-platform-ui/02-RESEARCH.md
@src/lib/types/customer.ts
@src/lib/types/financial.ts
@src/components/ui/health-indicator.tsx
@src/components/ui/badge.tsx
@src/components/ui/card.tsx
@src/lib/data/server/account-data.ts
@src/lib/data/server/alert-data.ts

# Plan 01 SUMMARY needed for component interfaces
@.planning/phases/02-core-platform-ui/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build account directory page with TanStack Table</name>
  <files>
    src/app/accounts/page.tsx
    src/app/accounts/components/account-table.tsx
    src/app/accounts/components/account-filters.tsx
    src/app/accounts/components/account-stats.tsx
  </files>
  <action>
    1. Create `src/app/accounts/page.tsx` as async Server Component:
       - Calls getAllCustomersWithHealth() and getCustomerCount() from account-data.ts
       - Renders page heading "Customer Accounts" with RefreshButton
       - Renders AccountStats summary row (total customers, health breakdown)
       - Renders AccountTable client component, passing customers data as props
       - Shows data freshness timestamp: "Data as of: {date}" using lastUpdated
       - Suspense boundary around AccountTable with table skeleton fallback
       - If data fetch fails, show error card with "Unable to load customer data"

    2. Create `src/app/accounts/components/account-stats.tsx` as Server Component:
       - Props: stats ({ total: number, byBU: Record<BU, number>, byHealth: { green: number, yellow: number, red: number } })
       - Row of 4 small stat cards:
         a) Total Customers: number with icon
         b) Healthy (green count): green text with HealthIndicator
         c) At Risk (yellow count): yellow text with HealthIndicator
         d) Critical (red count): red text with HealthIndicator
       - Tailwind: flex gap-4, each card bg-white rounded-lg p-4 shadow-sm

    3. Create `src/app/accounts/components/account-filters.tsx` as Client Component ("use client"):
       - Props: onBUFilter (callback), onHealthFilter (callback), activeBU (string|null), activeHealth (string|null)
       - Row of filter buttons:
         a) BU filter: "All" | "Cloudsense" | "Kandy" | "STL" buttons (pill-shaped, active has bg-blue-500)
         b) Health filter: "All" | "Healthy" | "At Risk" | "Critical" buttons (color-coded pills)
       - Clicking a filter calls the callback which updates table's column filter
       - Active filter has distinct styling (filled background)

    4. Create `src/app/accounts/components/account-table.tsx` as Client Component ("use client"):
       - Props: customers (CustomerWithHealth[] with bu field added)
       - Uses TanStack Table v8 (useReactTable) -- follow exact pattern from 02-RESEARCH.md Example 2
       - Columns:
         a) Customer Name: sortable, searchable, renders as bold text
         b) Business Unit: sortable, filterable, renders as Badge component
         c) Recurring Revenue: sortable, formatted as $XK or $X.XM, right-aligned
         d) Non-Recurring Revenue: sortable, formatted same way
         e) Total Revenue: sortable, formatted, font-semibold
         f) ARR: sortable, calculated as rr*4, formatted as $XK or $X.XM
         g) Health: sortable, renders HealthIndicator component
       - Features enabled:
         a) Global search: text input at top with placeholder "Search customers by name..."
         b) Column sorting: click header to sort asc/desc, show sort arrows
         c) Column filtering: BU and Health columns filterable via AccountFilters
         d) getCoreRowModel, getSortedRowModel, getFilteredRowModel from TanStack
       - Table styling: Tailwind classes matching 02-RESEARCH.md Example 2
         - Header: bg-slate-50, uppercase text-xs, cursor-pointer, hover:bg-slate-100
         - Rows: divide-y, hover:bg-slate-50
         - Cells: px-6 py-4 text-sm
       - Footer: "Showing X of Y customers" counter
       - Integrate AccountFilters component above table, below search
       - Debounce search input with 300ms delay (useEffect + setTimeout pattern from research)
  </action>
  <verify>
    Run `npm run build` -- should compile with zero errors.
    Run `npm run dev` and navigate to localhost:3000/accounts.
    Verify table renders with customer data (140 rows expected).
    Test search: type a customer name, verify table filters.
    Test sorting: click column headers, verify sort arrows and reordering.
    Test BU filter: click "Cloudsense", verify only Cloudsense customers shown.
  </verify>
  <done>
    Account directory page renders 140 customers in TanStack Table.
    Search filters customers by name with 300ms debounce.
    Column sorting works on all columns with visual sort indicators.
    BU filter buttons filter table to specific business units.
    Health filter buttons filter by health status (green/yellow/red).
    Health column shows accessible HealthIndicator for each customer.
    Financial columns show formatted revenue values (ARR, RR, NRR, Total).
    Data freshness timestamp visible.
    Requirements ACCT-01 (health score per customer), ACCT-02 (browse 140 customers with search/filter), ACCT-03 (financial metrics per account) satisfied.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build proactive alerts dashboard</name>
  <files>
    src/app/alerts/page.tsx
    src/app/alerts/components/alert-list.tsx
    src/app/alerts/components/alert-summary.tsx
  </files>
  <action>
    1. Create `src/app/alerts/page.tsx` as async Server Component:
       - Calls getProactiveAlerts() from alert-data.ts
       - Renders page heading "Proactive Alerts" with subtitle "At-risk accounts and metric anomalies"
       - Renders RefreshButton for manual data refresh
       - Renders AlertSummary at top (counts by severity)
       - Renders AlertList below (full alert cards)
       - Suspense boundary around content with alert skeleton fallback
       - If no alerts, show positive message: "All metrics within expected ranges. No active alerts."

    2. Create `src/app/alerts/components/alert-summary.tsx` as Server Component:
       - Props: alerts (Alert[])
       - Calculates: total alerts, red count, yellow count
       - Renders summary row with 3 stat cards:
         a) Total Alerts: number in bold
         b) Critical: red count with red badge
         c) Warning: yellow count with yellow badge
       - Tailwind: grid grid-cols-3 gap-4

    3. Create `src/app/alerts/components/alert-list.tsx` as Server Component:
       - Props: alerts (Alert[])
       - Renders each alert as a card with:
         a) Left border color based on severity (border-l-4, red-500 or yellow-500)
         b) Background tint (bg-red-50 for critical, bg-yellow-50 for warning)
         c) HealthIndicator showing severity
         d) Title (bold)
         e) Description (text-sm text-slate-600)
         f) Account name if present (with link potential for Phase 4)
         g) Metric name and current value vs threshold
         h) Timestamp (relative: "2 hours ago" using date-fns formatDistanceToNow)
       - Grid layout: 1 col on mobile, 2 cols on lg
       - Follow the exact AlertCard pattern from 02-RESEARCH.md Example 3
       - Sort: red alerts first, then yellow, within same severity sort by metric value impact

    4. Export Alert type from alert-data.ts if not already done in Plan 01:
       ```typescript
       export interface Alert {
         id: string
         severity: 'red' | 'yellow'
         title: string
         description: string
         accountName?: string
         metricName: string
         currentValue: number
         threshold: number
         timestamp: Date
       }
       ```
  </action>
  <verify>
    Run `npm run build` -- should compile with zero errors.
    Run `npm run dev` and navigate to localhost:3000/alerts.
    Verify alerts page renders with severity-sorted alert cards.
    Verify summary row shows correct counts.
    Verify red alerts appear before yellow alerts.
    Verify alert cards show account names, metric values, and descriptions.
  </verify>
  <done>
    Alerts page renders with severity-sorted alert cards.
    Summary row shows total, critical, and warning counts.
    Each alert card shows severity indicator, title, description, metric details.
    Red (critical) alerts appear before yellow (warning) alerts.
    Cards use appropriate background tints (red-50, yellow-50).
    Timestamps show relative time ("X hours ago").
    Empty state shows "No active alerts" message.
    Requirement DASH-02 (Proactive alerts dashboard) satisfied.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with zero errors
2. /accounts shows 140 customers in sortable table with search
3. Search filters customers by name in real-time (debounced)
4. BU filter buttons correctly filter to specific business units
5. Health column shows accessible indicators (color + icon + text)
6. Clicking column headers sorts data correctly
7. "Showing X of Y customers" counter updates with filters
8. /alerts shows severity-sorted alert cards with summary
9. Red alerts appear before yellow alerts
10. Alert cards show account names, metrics, and relative timestamps
11. Both pages show data freshness timestamps
</verification>

<success_criteria>
- /accounts route shows 140 customers with TanStack Table (sort, search, filter)
- Health indicators are accessible (color + icon + text + aria-label)
- BU filter and health filter work correctly
- Financial metrics (ARR, RR, NRR, Total) formatted as currency
- /alerts route shows at-risk accounts and anomalies sorted by severity
- Alert summary shows counts by severity level
- Both pages use real data from Phase 1 Excel adapter
- Requirements ACCT-01, ACCT-02, ACCT-03, DASH-02 all satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-platform-ui/02-03-SUMMARY.md`
</output>
