---
phase: 02-core-platform-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/layout.tsx
  - src/app/globals.css
  - src/app/page.tsx
  - src/app/dashboard/loading.tsx
  - src/app/accounts/loading.tsx
  - src/app/alerts/loading.tsx
  - src/components/ui/nav-bar.tsx
  - src/components/ui/kpi-card.tsx
  - src/components/ui/health-indicator.tsx
  - src/components/ui/badge.tsx
  - src/components/ui/card.tsx
  - src/components/ui/refresh-button.tsx
  - src/lib/data/server/dashboard-data.ts
  - src/lib/data/server/account-data.ts
  - src/lib/data/server/alert-data.ts
  - src/lib/types/customer.ts
autonomous: true

must_haves:
  truths:
    - "User sees a navigation bar with links to Dashboard, Accounts, and Alerts pages"
    - "User sees loading skeletons while page data loads"
    - "All pages share consistent visual styling with Tailwind"
    - "Server data functions return customers annotated with their BU name"
  artifacts:
    - path: "src/components/ui/nav-bar.tsx"
      provides: "Top navigation component with page links"
      min_lines: 20
    - path: "src/components/ui/kpi-card.tsx"
      provides: "KPI card showing current value, target, and delta"
      min_lines: 25
    - path: "src/components/ui/health-indicator.tsx"
      provides: "Accessible health score indicator with color + icon + text"
      min_lines: 20
    - path: "src/lib/data/server/dashboard-data.ts"
      provides: "Server-side data fetching for dashboard KPIs and BU summaries"
      exports: ["getDashboardData", "getBUSummaries", "getRevenueTrendData"]
    - path: "src/lib/data/server/account-data.ts"
      provides: "Server-side data fetching for customer list with health scores and BU annotation"
      exports: ["getAllCustomersWithHealth", "getCustomersByBU"]
    - path: "src/lib/types/customer.ts"
      provides: "CustomerWithHealth type extended with bu field"
      contains: "bu:"
  key_links:
    - from: "src/lib/data/server/dashboard-data.ts"
      to: "src/lib/data/registry/connector-factory.ts"
      via: "getConnectorFactory() calls to fetch Excel data"
      pattern: "getConnectorFactory"
    - from: "src/lib/data/server/account-data.ts"
      to: "src/lib/semantic/schema/customer.ts"
      via: "calculateHealthScore for each customer"
      pattern: "calculateHealthScore"
    - from: "src/components/ui/health-indicator.tsx"
      to: "CustomerWithHealth type"
      via: "healthScore prop typed as green|yellow|red"
      pattern: "green.*yellow.*red"
---

<objective>
Build the application shell (layout, navigation, shared UI components) and server-side data access functions that all Phase 2 pages will use.

Purpose: Every dashboard page needs navigation, consistent styling, loading states, and access to data from the Phase 1 foundation. This plan creates the shared infrastructure so Plans 02 and 03 can build pages independently.

Output: Working app shell with navigation between Dashboard/Accounts/Alerts routes, reusable UI components (KPICard, HealthIndicator, Badge, Card, RefreshButton), loading skeletons for each route, and server-side data fetching functions that bridge the ConnectorFactory/SemanticResolver to React Server Components.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-platform-ui/02-RESEARCH.md
@src/lib/types/financial.ts
@src/lib/types/customer.ts
@src/lib/semantic/resolver.ts
@src/lib/semantic/schema/customer.ts
@src/lib/data/registry/connector-factory.ts
@src/lib/data/providers/real-provider.ts
@src/app/layout.tsx
@src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install UI dependencies and build shared components</name>
  <files>
    package.json
    src/app/layout.tsx
    src/app/globals.css
    src/app/page.tsx
    src/app/dashboard/loading.tsx
    src/app/accounts/loading.tsx
    src/app/alerts/loading.tsx
    src/components/ui/nav-bar.tsx
    src/components/ui/kpi-card.tsx
    src/components/ui/health-indicator.tsx
    src/components/ui/badge.tsx
    src/components/ui/card.tsx
    src/components/ui/refresh-button.tsx
  </files>
  <action>
    1. Install UI dependencies: `npm install @tanstack/react-table recharts sonner`

    2. Update `src/app/globals.css` to include Tailwind base/components/utilities and add custom CSS variables for the Skyvera color palette (slate for backgrounds, blue for primary actions, status colors for health indicators).

    3. Update `src/app/layout.tsx`:
       - Add NavBar component at top
       - Wrap children in main content area with padding
       - Add Sonner Toaster component for notifications
       - Set metadata: title "Skyvera Intelligence Platform", description about business intelligence

    4. Update `src/app/page.tsx` to redirect to /dashboard (use redirect() from next/navigation).

    5. Create `src/components/ui/nav-bar.tsx` as a Client Component ("use client"):
       - Horizontal top bar with Skyvera logo/text on left
       - Navigation links: Dashboard, Accounts, Alerts
       - Use `usePathname()` from next/navigation to highlight active link
       - Links use Next.js `Link` component
       - Tailwind: bg-slate-900 text-white, active link has bg-slate-700 pill

    6. Create `src/components/ui/kpi-card.tsx` as Server Component:
       - Props: title (string), value (number), target (number), format ('currency' | 'percentage' | 'number')
       - Shows: title, formatted value (e.g., $14.7M, 62.5%), target comparison
       - Delta indicator: green up arrow if value >= target, red down arrow if below
       - Delta shows percentage difference from target
       - Tailwind: bg-white rounded-lg shadow-sm border-slate--200 p-6
       - Use the exact pattern from 02-RESEARCH.md Pattern 6

    7. Create `src/components/ui/health-indicator.tsx` as Server Component:
       - Props: score ('green' | 'yellow' | 'red'), label (optional string)
       - Config map: green = checkmark icon + "Healthy", yellow = warning icon + "At Risk", red = X icon + "Critical"
       - MUST include aria-label for accessibility (never color alone)
       - Use the exact pattern from 02-RESEARCH.md Pattern 5

    8. Create `src/components/ui/badge.tsx` as Server Component:
       - Props: variant ('default' | 'success' | 'warning' | 'danger'), children
       - Small pill-shaped badge with color-coded background
       - Used for BU labels, status tags

    9. Create `src/components/ui/card.tsx` as Server Component:
       - Props: title (optional string), children, className (optional)
       - White card with border, shadow, optional title header
       - Composable wrapper for dashboard sections

    10. Create `src/components/ui/refresh-button.tsx` as Client Component ("use client"):
        - Props: onRefresh (async function), label (optional)
        - Button with refresh icon, shows loading spinner during refresh
        - Uses useRouter().refresh() to revalidate server data
        - Tailwind: text-sm text-slate-500 hover:text-slate-700

    11. Create loading.tsx files for each route:
        - `src/app/dashboard/loading.tsx`: Grid of 4 pulse-animated KPI card skeletons + 2 chart skeletons
        - `src/app/accounts/loading.tsx`: Search bar skeleton + table rows skeleton (8 rows)
        - `src/app/alerts/loading.tsx`: Grid of 4 alert card skeletons
        - All use Tailwind animate-pulse with slate-200 backgrounds matching actual layout
  </action>
  <verify>
    Run `npm run build` -- should compile with zero errors.
    Verify all component files exist and have correct exports.
    Run `npm run dev` and verify navigation renders at localhost:3000.
  </verify>
  <done>
    NavBar renders with 3 navigation links. Home page redirects to /dashboard.
    Loading skeletons display for each route. All shared UI components exported correctly.
    Build passes with zero TypeScript errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build server-side data access functions</name>
  <files>
    src/lib/types/customer.ts
    src/lib/data/server/dashboard-data.ts
    src/lib/data/server/account-data.ts
    src/lib/data/server/alert-data.ts
  </files>
  <action>
    Create server-side data fetching functions that Server Components will call directly (NO API routes needed per research). These functions bridge the Phase 1 ConnectorFactory/SemanticResolver to the UI layer.

    **CRITICAL: Extend CustomerWithHealth type with `bu` field FIRST.**
    Before building data functions, update `src/lib/types/customer.ts`:
    - Add `bu: z.string()` (or `bu: BUEnumSchema`) to CustomerWithHealthSchema so that CustomerWithHealth includes a `bu` field.
    - This is required because customers are fetched per-BU from BUCustomerData, and downstream consumers (account-table.tsx in Plan 02-03) need the `bu` field on each customer record for filtering and display.
    - The extended schema should look like:
      ```typescript
      export const CustomerWithHealthSchema = CustomerSchema.extend({
        bu: z.string(), // BU name annotated during data assembly
        healthScore: z.enum(['green', 'yellow', 'red']),
        healthFactors: z.array(z.string()),
      })
      ```

    1. Create `src/lib/data/server/dashboard-data.ts`:
       - `getDashboardData()`: Returns consolidated financials for all BUs
         - Calls getConnectorFactory() to get Excel adapter
         - Fetches financials for each BU (Cloudsense, Kandy, STL)
         - Calculates totals: totalRevenue, totalRR, totalNRR, EBITDA, netMarginPct
         - Returns object with: totalRevenue, totalRR, rrTarget (prior period), totalNRR, ebitda, ebitdaTarget, netMarginPct, netMarginTarget (68.7% from CLAUDE.md), headcount (58 from CLAUDE.md)
         - Include `lastUpdated: Date` timestamp for data freshness
         - Use Result type for error handling

       - `getBUSummaries()`: Returns array of per-BU summary objects
         - For each BU: bu name, totalRR, totalNRR, totalRevenue, customerCount, netMarginPct, netMarginTarget
         - Targets from CLAUDE.md: Cloudsense 63.6%, Kandy 75%, STL 75%
         - Returns BUFinancialSummary[] (from types/financial.ts)

       - `getRevenueTrendData()`: Returns chart-ready data for revenue trend
         - Format: Array of { quarter: string, revenue: number, target: number }
         - For demo: generate Q1-Q4 data points using current quarterly data as baseline
         - Include current quarter actuals and prior quarters estimated

    2. Create `src/lib/data/server/account-data.ts`:
       - `getAllCustomersWithHealth()`: Returns all 140 customers with health scores AND bu field
         - Fetches customers from all BUs via ConnectorFactory
         - For each BU's customer list, annotates each customer with `bu: buName` before calculating health
         - Calls calculateHealthScore() from semantic/schema/customer.ts for each
         - Returns CustomerWithHealth[] (which now includes `bu` field) sorted by total revenue descending
         - Each customer has: customer_name, bu, rr, nrr, total, arr (rr*4), healthScore, healthFactors
         - Include `lastUpdated: Date` for freshness timestamp

       - `getCustomersByBU(bu: BU)`: Returns customers for specific BU with health
         - Same as above but filtered to single BU

       - `getCustomerCount()`: Returns { total: number, byBU: Record<BU, number>, byHealth: { green: number, yellow: number, red: number } }

    3. Create `src/lib/data/server/alert-data.ts`:
       - `getProactiveAlerts()`: Returns alerts for at-risk accounts and anomalies
         - Scan all customers for health score = 'red' or 'yellow'
         - Generate alerts for:
           a) Customers with renewals at risk (will_renew = 'No')
           b) Customers with zero RR but positive NRR (churn signal)
           c) BU-level margin below target (from CLAUDE.md targets)
           d) High AR > 90 days customers (use $1.28M total from CLAUDE.md, distribute proportionally)
         - Each alert has: id (generated), severity ('red'|'yellow'), title, description, accountName (optional), metricName, currentValue, threshold, timestamp
         - Sort by severity (red first) then by impact (higher value first)
         - Return Alert[]

    All functions:
    - Are async and use try/catch with Result type
    - Wrap ConnectorFactory calls with proper error handling
    - Return typed data matching component expectations
    - Can be called directly from Server Components (no API route needed)
    - Log errors to console but don't throw (graceful degradation)
  </action>
  <verify>
    Run `npm run build` -- should compile with zero errors (data functions are valid TypeScript).
    Check that all exported functions are properly typed with return types.
    Verify imports from Phase 1 modules resolve correctly.
    Verify CustomerWithHealth type now includes `bu` field: grep for "bu:" in src/lib/types/customer.ts.
    Verify getAllCustomersWithHealth() annotates each customer with its BU: grep for "bu:" or "bu_name" in src/lib/data/server/account-data.ts.
  </verify>
  <done>
    CustomerWithHealth type extended with `bu: string` field.
    Three server-side data modules export all required functions.
    getDashboardData returns consolidated financial KPIs with freshness timestamps.
    getAllCustomersWithHealth returns 140 customers with health scores AND bu field populated.
    getProactiveAlerts returns sorted alerts for at-risk accounts.
    Build passes with zero TypeScript errors.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with zero errors
2. `npm run dev` starts and shows navigation bar at localhost:3000
3. Home page (/) redirects to /dashboard
4. Loading skeletons appear for /dashboard, /accounts, /alerts routes
5. All shared UI components render without errors
6. Data functions compile and import Phase 1 modules correctly
7. CustomerWithHealth type includes `bu` field (grep confirms)
8. getAllCustomersWithHealth() returns customers with `bu` populated from BU iteration
</verification>

<success_criteria>
- Navigation bar with Dashboard/Accounts/Alerts links renders on all pages
- Loading skeletons appear during route transitions
- 6 shared UI components (NavBar, KPICard, HealthIndicator, Badge, Card, RefreshButton) are available
- 3 server data modules (dashboard-data, account-data, alert-data) export typed functions
- All functions use Phase 1 foundation (ConnectorFactory, SemanticResolver, calculateHealthScore)
- CustomerWithHealth type includes `bu` field for downstream consumers (account-table in Plan 03)
- Build passes with zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-platform-ui/02-01-SUMMARY.md`
</output>
