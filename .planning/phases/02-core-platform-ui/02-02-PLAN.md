---
phase: 02-core-platform-ui
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/app/dashboard/page.tsx
  - src/app/dashboard/components/kpi-section.tsx
  - src/app/dashboard/components/bu-breakdown.tsx
  - src/app/dashboard/components/revenue-chart.tsx
  - src/app/dashboard/components/margin-comparison.tsx
  - src/app/dashboard/components/recent-alerts-preview.tsx
autonomous: true

must_haves:
  truths:
    - "User sees 4 KPI cards showing Total Revenue, EBITDA, Net Margin, and Recurring Revenue with current vs target"
    - "User sees multi-BU breakdown showing Cloudsense, Kandy, and STL performance side-by-side"
    - "User sees revenue trend chart with actual vs target line"
    - "User sees margin comparison across BUs with target indicators"
    - "User sees preview of recent alerts at bottom of dashboard"
  artifacts:
    - path: "src/app/dashboard/page.tsx"
      provides: "Dashboard Server Component with Suspense boundaries for streaming"
      min_lines: 30
    - path: "src/app/dashboard/components/bu-breakdown.tsx"
      provides: "BU comparison cards showing per-BU revenue, margin, customer count"
      min_lines: 30
    - path: "src/app/dashboard/components/revenue-chart.tsx"
      provides: "Recharts line chart showing revenue trend with target overlay"
      min_lines: 40
  key_links:
    - from: "src/app/dashboard/page.tsx"
      to: "src/lib/data/server/dashboard-data.ts"
      via: "Direct import and call in Server Component"
      pattern: "getDashboardData|getBUSummaries"
    - from: "src/app/dashboard/components/revenue-chart.tsx"
      to: "recharts"
      via: "LineChart, ResponsiveContainer imports"
      pattern: "from.*recharts"
    - from: "src/app/dashboard/components/kpi-section.tsx"
      to: "src/components/ui/kpi-card.tsx"
      via: "Renders 4 KPICard instances with dashboard data"
      pattern: "KPICard"
---

<objective>
Build the financial KPI dashboard page showing multi-BU breakdown with current vs target metrics, revenue trend charts, and margin comparisons.

Purpose: This is the primary executive landing page (DASH-01). Executives need to see total revenue, EBITDA, margins, and per-BU performance at a glance with visual indicators of whether targets are being met.

Output: Working /dashboard route with 4 KPI cards, BU breakdown section, revenue trend chart (Recharts), margin comparison, and alerts preview -- all fetching real data from Phase 1 Excel adapter via server data functions from Plan 01.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-platform-ui/02-RESEARCH.md
@src/lib/types/financial.ts
@src/lib/types/customer.ts
@src/components/ui/kpi-card.tsx
@src/components/ui/card.tsx
@src/components/ui/health-indicator.tsx
@src/components/ui/badge.tsx
@src/lib/data/server/dashboard-data.ts
@src/lib/data/server/alert-data.ts

# Plan 01 SUMMARY needed for component interfaces
@.planning/phases/02-core-platform-ui/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build dashboard page with KPI section and BU breakdown</name>
  <files>
    src/app/dashboard/page.tsx
    src/app/dashboard/components/kpi-section.tsx
    src/app/dashboard/components/bu-breakdown.tsx
    src/app/dashboard/components/recent-alerts-preview.tsx
  </files>
  <action>
    1. Create `src/app/dashboard/page.tsx` as the main dashboard Server Component:
       - Use Suspense boundaries to stream each section independently (per 02-RESEARCH.md Pattern 2)
       - Structure: heading "Executive Dashboard" + refresh button + last updated timestamp
       - Sections wrapped in Suspense: KPISection, then a 2-column grid with ChartSection and BUSection, then AlertsPreview
       - Each section is its own async Server Component that fetches data independently
       - Skeleton fallbacks for each Suspense boundary matching the loading.tsx structure
       - Layout: `p-6 space-y-6` for vertical spacing between sections

    2. Create `src/app/dashboard/components/kpi-section.tsx` as async Server Component:
       - Calls getDashboardData() from server data functions
       - Renders 4 KPICard instances in a responsive grid (1 col mobile, 2 cols md, 4 cols lg):
         a) Total Revenue: format='currency', value=totalRevenue, target=revenueTarget
         b) EBITDA: format='currency', value=ebitda, target=ebitdaTarget
         c) Net Margin: format='percentage', value=netMarginPct, target=68.7
         d) Recurring Revenue: format='currency', value=totalRR, target=rrTarget
       - Shows data freshness: "Last updated: X minutes ago" below the grid using the lastUpdated timestamp
       - If getDashboardData fails, show error card with "Unable to load financial data" message

    3. Create `src/app/dashboard/components/bu-breakdown.tsx` as async Server Component:
       - Calls getBUSummaries() from server data functions
       - Renders a Card for each BU (Cloudsense, Kandy, STL) in a vertical stack
       - Each BU card shows:
         a) BU name as heading with Badge showing customer count
         b) Revenue row: Total Revenue formatted as $XM
         c) RR/NRR split: bar showing RR vs NRR proportions with labels
         d) Net Margin: percentage with color indicator (green if >= target, red if below)
         e) Target margin shown next to actual
       - Use Tailwind for the proportional bar (flex with percentage widths)
       - If getBUSummaries fails, show error message

    4. Create `src/app/dashboard/components/recent-alerts-preview.tsx` as async Server Component:
       - Calls getProactiveAlerts() from server data functions
       - Shows top 3 alerts only (preview, not full list)
       - Each alert: severity indicator (HealthIndicator component), title, brief description
       - "View all alerts" link at bottom navigating to /alerts
       - Wrapped in Card component with title "Recent Alerts"
       - If no alerts, show "All metrics within expected ranges" message
  </action>
  <verify>
    Run `npm run build` -- should compile with zero errors.
    Run `npm run dev` and navigate to localhost:3000/dashboard.
    Verify KPI cards render with financial data from Excel adapter.
    Verify BU breakdown shows 3 business units.
  </verify>
  <done>
    Dashboard page renders 4 KPI cards with real financial data and target comparisons.
    BU breakdown shows Cloudsense, Kandy, STL with revenue, margins, and customer counts.
    Recent alerts preview shows top 3 alerts with severity indicators.
    All sections stream independently via Suspense boundaries.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build revenue chart and margin comparison</name>
  <files>
    src/app/dashboard/components/revenue-chart.tsx
    src/app/dashboard/components/margin-comparison.tsx
  </files>
  <action>
    1. Create `src/app/dashboard/components/revenue-chart.tsx` as a Client Component ("use client"):
       - Props: data (Array of { quarter: string, revenue: number, target: number })
       - Uses Recharts (LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer)
       - Wrapped in Card component with title "Revenue Trend"
       - ResponsiveContainer with width="100%" height={300}
       - Two lines: "Actual Revenue" (blue #3b82f6, solid, strokeWidth 2) and "Target" (slate #94a3b8, dashed)
       - Tooltip formatter showing dollar values as $X.XM
       - YAxis formatter showing $XM
       - Grid with subtle dashed lines
       - Follow the exact Recharts pattern from 02-RESEARCH.md Pattern 7

    2. Create a wrapper async Server Component in dashboard/page.tsx that:
       - Calls getRevenueTrendData() from server data functions
       - Passes data as props to the RevenueChart client component
       - This keeps data fetching server-side (02-RESEARCH.md anti-pattern: no client-side fetching)

    3. Create `src/app/dashboard/components/margin-comparison.tsx` as a Client Component ("use client"):
       - Props: buSummaries (BUFinancialSummary[])
       - Uses Recharts BarChart to show margin comparison across BUs
       - Two bar groups per BU: Actual Margin (blue) and Target Margin (slate/gray)
       - ResponsiveContainer with width="100%" height={250}
       - YAxis: 0-100% range
       - Tooltip showing exact percentages
       - Each bar labeled with BU name on XAxis
       - Color-code actual bars: green if >= target, red if below target

    4. Update dashboard/page.tsx to include both chart components:
       - 2-column grid on large screens, stacked on mobile
       - Left column: RevenueChart (wrapped in Suspense with ChartSkeleton fallback)
       - Right column: MarginComparison (wrapped in Suspense with ChartSkeleton fallback)
       - Both receive data from server-side async wrapper components
  </action>
  <verify>
    Run `npm run build` -- should compile with zero errors.
    Run `npm run dev` and navigate to localhost:3000/dashboard.
    Verify revenue trend chart renders with line data.
    Verify margin comparison shows bars for each BU with target overlay.
    Verify charts are responsive (resize browser window).
  </verify>
  <done>
    Revenue trend chart renders with actual vs target lines using Recharts.
    Margin comparison chart shows per-BU actual vs target margins.
    Both charts are responsive and have tooltips.
    Charts receive data from Server Components (no client-side fetching).
    Dashboard page is complete with all 5 sections: KPIs, Charts (2), BU Breakdown, Alerts Preview.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with zero errors
2. `npm run dev` starts and /dashboard shows complete executive view
3. 4 KPI cards show real financial data with target deltas
4. Revenue trend chart renders with Recharts (actual vs target lines)
5. Margin comparison shows per-BU bars with target overlay
6. BU breakdown shows 3 BUs with revenue, margins, customer counts
7. Recent alerts preview shows top 3 alerts with link to /alerts
8. All sections use Suspense and show loading skeletons during data fetch
9. Data freshness timestamp ("Last updated X min ago") is visible
</verification>

<success_criteria>
- /dashboard route renders complete executive financial view
- 4 KPI cards: Total Revenue, EBITDA, Net Margin, Recurring Revenue with current vs target
- Recharts line chart showing revenue trend
- Recharts bar chart comparing BU margins to targets
- BU breakdown cards for Cloudsense, Kandy, STL
- Alerts preview with top 3 items and "View all" link
- All data sourced from Phase 1 Excel adapter via server data functions
- Requirement DASH-01 (Enhanced financial KPI dashboard with multi-BU breakdown) satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-platform-ui/02-02-SUMMARY.md`
</output>
