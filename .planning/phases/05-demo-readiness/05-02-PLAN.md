---
phase: 05-demo-readiness
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/data/server/dashboard-data.ts
  - src/app/dashboard/page.tsx
  - src/app/accounts/[name]/page.tsx
  - src/app/accounts/page.tsx
  - src/app/alerts/page.tsx
  - src/app/query/page.tsx
  - src/app/scenario/page.tsx
  - src/lib/cache/manager.ts
autonomous: true

must_haves:
  truths:
    - "Dashboard loads in under 2 seconds on second visit (cache hit)"
    - "Manual refresh buttons are visible and functional in all views with loading indicators"
    - "Account plan page transitions between tabs in under 500ms"
  artifacts:
    - path: "src/lib/data/server/dashboard-data.ts"
      provides: "Cached dashboard data with 5-minute TTL"
      contains: "getCacheManager"
    - path: "src/lib/cache/manager.ts"
      provides: "DEMO_MODE flag for extended cache TTLs"
      contains: "DEMO_MODE"
  key_links:
    - from: "src/app/dashboard/page.tsx"
      to: "src/lib/data/server/dashboard-data.ts"
      via: "cached data fetching"
      pattern: "getDashboardData"
    - from: "src/lib/cache/manager.ts"
      to: "all data server functions"
      via: "getCacheManager singleton"
      pattern: "getCacheManager"
---

<objective>
Optimize performance with aggressive caching and ensure refresh buttons work across all views.

Purpose: Meet the <2s dashboard load target and <500ms view transition target from CONTEXT.md. Dashboard data cached for 5 minutes (fast load over freshness). Add DEMO_MODE config for extended TTLs during actual demo (30min dashboard, 60min intelligence). Ensure every page has a visible, functional refresh button with loading indicator.

Output: Cached dashboard data functions, DEMO_MODE cache config, refresh buttons verified on all pages.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-demo-readiness/05-CONTEXT.md
@src/lib/cache/manager.ts
@src/lib/data/server/dashboard-data.ts
@src/app/dashboard/page.tsx
@src/components/ui/refresh-button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Aggressive dashboard caching and DEMO_MODE config</name>
  <files>
    src/lib/cache/manager.ts
    src/lib/data/server/dashboard-data.ts
  </files>
  <action>
    1. Update src/lib/cache/manager.ts:
       - Add DEMO_MODE detection: `const DEMO_MODE = process.env.DEMO_MODE === 'true'`
       - Add DEMO_CACHE_TTL constants alongside existing CACHE_TTL:
         ```
         export const DEMO_CACHE_TTL = {
           FINANCIAL: 1800,       // 30 minutes (was 5min)
           NEWS: 3600,            // 60 minutes (was 15min)
           CLAUDE_RESPONSE: 1800, // 30 minutes (was 5min)
           CLAUDE_ENRICHMENT: 3600, // 60 minutes (was 15min)
           CUSTOMER_DATA: 1800,   // 30 minutes (was 10min)
         } as const
         ```
       - Add helper: `export function getActiveTTL(): typeof CACHE_TTL { return DEMO_MODE ? DEMO_CACHE_TTL : CACHE_TTL }`
       - Do NOT change existing CACHE_TTL values or CacheManager class behavior

    2. Update src/lib/data/server/dashboard-data.ts:
       - Wrap getDashboardData() with cache-aside pattern using getCacheManager():
         ```
         const cache = getCacheManager()
         const ttl = getActiveTTL()
         return cache.get('dashboard:overview', async () => { ...existing logic... }, { ttl: ttl.FINANCIAL })
         ```
       - Similarly wrap getBUSummaries() with cache key 'dashboard:bu-summaries'
       - Similarly wrap getRevenueTrendData() with cache key 'dashboard:revenue-trend'
       - Keep existing Result<T, Error> return types -- the cache stores the Result value, fetcher returns the Result
       - On cache hit, dashboard data serves from memory (sub-100ms)

    Important: The CacheManager.get() already implements cache-aside (check cache, call fetcher on miss, store result). Use this existing pattern. Do NOT use unstable_cache from Next.js -- the existing in-memory CacheManager is the caching layer for this project.
  </action>
  <verify>
    Run `npx tsc --noEmit` should pass.
    Run `grep -n "DEMO_MODE" src/lib/cache/manager.ts` should show the flag.
    Run `grep -n "cache.get" src/lib/data/server/dashboard-data.ts` should show 3 cached calls.
  </verify>
  <done>
    Dashboard data functions use cache-aside pattern with 5-minute TTL (normal) or 30-minute TTL (DEMO_MODE). Second dashboard load serves from in-memory cache in sub-100ms.
  </done>
</task>

<task type="auto">
  <name>Task 2: Ensure refresh buttons on all pages</name>
  <files>
    src/app/accounts/page.tsx
    src/app/alerts/page.tsx
    src/app/query/page.tsx
    src/app/scenario/page.tsx
    src/app/accounts/[name]/page.tsx
  </files>
  <action>
    Audit each page and ensure RefreshButton is imported and rendered in the page header. The existing RefreshButton component at src/components/ui/refresh-button.tsx already handles:
    - Spinning animation during refresh (animate-spin on SVG)
    - Disabled state while refreshing
    - Calls router.refresh() to revalidate server components
    - Accepts optional onRefresh callback

    For each page, check if RefreshButton already exists in the header area. If missing, add it:

    1. src/app/accounts/page.tsx - Add RefreshButton next to page title in header flex row
    2. src/app/alerts/page.tsx - Add RefreshButton next to page title
    3. src/app/query/page.tsx - Add RefreshButton next to page title (if not already present)
    4. src/app/scenario/page.tsx - Add RefreshButton next to page title (if not already present)
    5. src/app/accounts/[name]/page.tsx - Add RefreshButton in the account plan header (next to customer name)

    Pattern for each page header:
    ```tsx
    <div className="flex justify-between items-center">
      <h1 className="text-3xl font-bold text-slate-900">{Title}</h1>
      <RefreshButton label="Refresh Data" />
    </div>
    ```

    Import: `import { RefreshButton } from '@/components/ui/refresh-button'`

    Do NOT modify pages that already have RefreshButton correctly placed.
    Dashboard already has it (confirmed in page.tsx).
  </action>
  <verify>
    Run `grep -rn "RefreshButton" src/app/*/page.tsx src/app/accounts/\[name\]/page.tsx` should show RefreshButton imported and used in all 6 pages (dashboard, accounts, accounts/[name], alerts, query, scenario).
    Run `npx tsc --noEmit` should pass.
  </verify>
  <done>
    Every page (dashboard, accounts, account plan, alerts, query, scenario) has a visible RefreshButton in its header with spinning loading indicator during refresh.
  </done>
</task>

</tasks>

<verification>
- `grep -rn "RefreshButton" src/app/ --include="page.tsx"` shows usage in all 6 pages
- `grep -n "DEMO_MODE" src/lib/cache/manager.ts` shows DEMO_MODE config
- `grep -n "cache.get" src/lib/data/server/dashboard-data.ts` shows cached data functions
- `npx tsc --noEmit` passes
</verification>

<success_criteria>
Dashboard data functions cached with 5-minute TTL (30min in DEMO_MODE). Second dashboard load serves from cache in sub-100ms. Every page has a visible, functional refresh button with loading animation. DEMO_MODE=true extends all cache TTLs for demo stability.
</success_criteria>

<output>
After completion, create `.planning/phases/05-demo-readiness/05-02-SUMMARY.md`
</output>
