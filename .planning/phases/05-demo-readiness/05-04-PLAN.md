---
phase: 05-demo-readiness
plan: 04
type: execute
wave: 2
depends_on: ["05-01", "05-02", "05-03"]
files_modified:
  - playwright.config.ts
  - tests/e2e/demo-flow.spec.ts
  - tests/smoke/dashboard.spec.ts
  - tests/smoke/accounts.spec.ts
  - tests/smoke/account-plan.spec.ts
  - tests/pages/dashboard.page.ts
  - tests/pages/accounts.page.ts
  - tests/pages/account-plan.page.ts
  - package.json
autonomous: false

must_haves:
  truths:
    - "System completes full end-to-end demo flow testing 3x without critical failures"
    - "Dashboard loads in under 2 seconds (validated by Playwright assertion)"
    - "All major pages render without error states visible"
  artifacts:
    - path: "playwright.config.ts"
      provides: "Playwright configuration with webServer, real API calls (no mocking)"
      contains: "defineConfig"
    - path: "tests/e2e/demo-flow.spec.ts"
      provides: "Critical demo walkthrough test: Dashboard -> Accounts -> Account Plan -> Intelligence"
      contains: "demo"
    - path: "tests/smoke/dashboard.spec.ts"
      provides: "Dashboard smoke tests: KPIs visible, load time, refresh button"
      contains: "Dashboard"
    - path: "tests/pages/dashboard.page.ts"
      provides: "Page Object Model for dashboard locators and actions"
      contains: "DashboardPage"
  key_links:
    - from: "tests/e2e/demo-flow.spec.ts"
      to: "tests/pages/dashboard.page.ts"
      via: "Page Object Model import"
      pattern: "DashboardPage"
    - from: "playwright.config.ts"
      to: "npm run dev"
      via: "webServer command"
      pattern: "webServer"
---

<objective>
Install Playwright, create E2E demo flow test and smoke tests, validate system passes 3x consecutively.

Purpose: CONTEXT.md requires "Demo flow must pass 3x without critical failures before sign-off" and "Test with real API calls to validate rate limiting and error handling under production conditions." This plan creates the complete Playwright test suite with Page Object Models, runs the demo flow test 3 times, and validates all success criteria from the phase.

Output: Playwright configured, Page Object Models for 3 main pages, demo flow E2E test, smoke tests for dashboard/accounts/account-plan, 3x consecutive passing runs.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-demo-readiness/05-CONTEXT.md
@.planning/phases/05-demo-readiness/05-RESEARCH.md
@src/app/dashboard/page.tsx
@src/app/accounts/page.tsx
@src/app/accounts/[name]/page.tsx
@src/components/ui/refresh-button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Playwright, create config and Page Object Models</name>
  <files>
    playwright.config.ts
    tests/pages/dashboard.page.ts
    tests/pages/accounts.page.ts
    tests/pages/account-plan.page.ts
    package.json
  </files>
  <action>
    1. Install Playwright:
       ```
       npm install -D @playwright/test
       npx playwright install chromium
       ```
       Only install chromium browser (not all 3) to save time. Demo happens in Chrome.

    2. Create playwright.config.ts at project root:
       - testDir: './tests'
       - fullyParallel: false (run sequentially to avoid port conflicts)
       - retries: 1 (retry once on failure to handle network flakiness)
       - reporter: [['html'], ['list']]
       - use.baseURL: 'http://localhost:3000'
       - use.trace: 'retain-on-failure'
       - use.screenshot: 'only-on-failure'
       - projects: [{ name: 'chromium', use: { ...devices['Desktop Chrome'] } }]
       - webServer: { command: 'npm run dev', url: 'http://localhost:3000', timeout: 120_000, reuseExistingServer: true }
       - IMPORTANT: Do NOT mock any network requests. Real API calls validate production behavior.

    3. Create Page Object Models:

    tests/pages/dashboard.page.ts:
    - Locators: totalRevenueKPI (getByText matching dollar amount or "Total Revenue" heading), netMarginKPI, ebitdaKPI, accountsNavLink (getByRole link "Accounts"), refreshButton (getByRole button "Refresh"), pageTitle (text "Executive Dashboard")
    - Methods: goto(), clickAccountsNav(), clickRefresh(), waitForDataLoaded() (waits for KPI values to appear, not loading skeletons)

    tests/pages/accounts.page.ts:
    - Locators: accountTable (role table or getByTestId), searchInput (getByPlaceholder or getByRole searchbox), firstAccountRow, pageTitle
    - Methods: goto(), searchByName(name: string), clickFirstAccount(), waitForTableLoaded()

    tests/pages/account-plan.page.ts:
    - Locators: overviewTab, financialsTab, intelligenceTab, actionItemsTab, customerName, backLink, tabContent
    - Methods: goto(accountName: string), clickTab(tabName: string), waitForTabContent()

    Use role-based and text-based locators (getByRole, getByText) NOT CSS selectors. This prevents flaky tests from UI changes.

    Add to package.json scripts: `"test:e2e": "npx playwright test"`, `"test:e2e:ui": "npx playwright test --ui"`
  </action>
  <verify>
    Run `npx playwright --version` should show installed version.
    Run `npx tsc --noEmit -p tsconfig.json` or `npx playwright test --list` should list test files (no syntax errors).
    Verify `ls tests/pages/` shows 3 page object files.
  </verify>
  <done>
    Playwright installed with chromium, config created with webServer, 3 Page Object Models created with role-based locators. npm test:e2e script registered.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create demo flow E2E test and smoke tests</name>
  <files>
    tests/e2e/demo-flow.spec.ts
    tests/smoke/dashboard.spec.ts
    tests/smoke/accounts.spec.ts
    tests/smoke/account-plan.spec.ts
  </files>
  <action>
    Create 4 test files using the Page Object Models from Task 1.

    1. tests/e2e/demo-flow.spec.ts - Critical demo walkthrough:
       ```
       test('Complete demo walkthrough', async ({ page }) => {
         // Step 1: Dashboard loads with KPIs visible
         const dashboard = new DashboardPage(page)
         await dashboard.goto()
         await dashboard.waitForDataLoaded()
         // Verify no error states
         await expect(page.getByText('temporarily unavailable')).not.toBeVisible()

         // Step 2: Navigate to Accounts
         await dashboard.clickAccountsNav()
         const accounts = new AccountsPage(page)
         await accounts.waitForTableLoaded()

         // Step 3: Search for hero account (British Telecom)
         await accounts.searchByName('British')
         // Verify results appear
         await expect(accounts.firstAccountRow).toBeVisible()

         // Step 4: Open account plan
         await accounts.clickFirstAccount()
         const accountPlan = new AccountPlanPage(page)
         // Verify tabs render
         await expect(accountPlan.overviewTab).toBeVisible()

         // Step 5: Check multiple tabs
         await accountPlan.clickTab('financials')
         await accountPlan.waitForTabContent()
         await accountPlan.clickTab('intelligence')
         await accountPlan.waitForTabContent()

         // Step 6: Verify refresh button works
         // Navigate back to dashboard
         await page.goto('/dashboard')
         await dashboard.waitForDataLoaded()
       })

       test('Demo flow passes 3 consecutive times', async ({ page }) => {
         for (let run = 1; run <= 3; run++) {
           await test.step(`Run ${run}/3`, async () => {
             const dashboard = new DashboardPage(page)
             await dashboard.goto()
             await dashboard.waitForDataLoaded()
             await dashboard.clickAccountsNav()
             const accounts = new AccountsPage(page)
             await accounts.waitForTableLoaded()
             await accounts.searchByName('British')
             await accounts.clickFirstAccount()
             const accountPlan = new AccountPlanPage(page)
             await expect(accountPlan.overviewTab).toBeVisible()
           })
         }
       })
       ```

    2. tests/smoke/dashboard.spec.ts:
       - test: Dashboard page loads (title visible, no errors)
       - test: KPIs display real values (not loading skeletons)
       - test: Refresh button is visible and clickable
       - test: Navigation links work (Accounts, Alerts, Query, Scenario)

    3. tests/smoke/accounts.spec.ts:
       - test: Accounts page loads with table visible
       - test: Search/filter works (type "British", results narrow)
       - test: Account rows are clickable (navigate to account plan)

    4. tests/smoke/account-plan.spec.ts:
       - test: Account plan page loads for hero account (British Telecom)
       - test: All 7 tabs are visible (overview, financials, organization, strategy, competitive, intelligence, action-items)
       - test: Tab switching works (click each tab, content area updates)
       - test: Back link returns to accounts list

    Use generous timeouts for real API calls: { timeout: 15000 } for Intelligence tab (Claude API).
    All tests must use auto-waiting (Playwright built-in). Do NOT use page.waitForTimeout() manual waits.

    For the account plan URL, use the URL-encoded customer name format matching the existing route: /accounts/{encodeURIComponent(name)}
  </action>
  <verify>
    Start the dev server (`npm run dev`) then run `npx playwright test` -- all tests should pass.
    If any tests fail, fix the test (adjust locators/selectors to match actual rendered UI) and re-run.
    Run `npx playwright test tests/e2e/demo-flow.spec.ts` specifically to verify the 3x consecutive test passes.
  </verify>
  <done>
    Demo flow E2E test passes 3 consecutive times. All smoke tests pass. No flaky tests (uses role-based locators and auto-waiting). Test results visible in Playwright HTML report.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Playwright test suite for demo readiness validation:
    - E2E demo flow test (Dashboard -> Accounts -> Account Plan -> tabs)
    - 3x consecutive pass validation
    - Smoke tests for dashboard, accounts, and account plan pages
    - All tests use real API calls (no mocks) per CONTEXT.md requirement
  </what-built>
  <how-to-verify>
    1. Run `npm run test:e2e` and verify all tests pass
    2. Check Playwright HTML report: `npx playwright show-report`
    3. Manually open http://localhost:3000/dashboard in Chrome browser
    4. Walk through the demo flow: Dashboard -> Accounts -> click British Telecom -> browse tabs
    5. Verify no white screens, no technical error messages, no blank spaces
    6. Click Refresh button on dashboard, verify spinning animation and data refresh
    7. Test error resilience: Temporarily rename .env ANTHROPIC_API_KEY, reload account plan intelligence tab -- should show graceful error message, not crash
  </how-to-verify>
  <resume-signal>Type "approved" if demo is ready, or describe issues found during verification</resume-signal>
</task>

</tasks>

<verification>
- `npx playwright test` passes with 0 failures
- `npx playwright test tests/e2e/demo-flow.spec.ts` shows "3 consecutive times" test passing
- `npx playwright show-report` opens HTML report with all green
- Manual browser walkthrough shows no white screens or technical errors
</verification>

<success_criteria>
Playwright test suite installed and configured. E2E demo flow test passes 3 consecutive times with real API calls. Smoke tests validate all major pages. Human verification confirms demo is ready for executive presentation.
</success_criteria>

<output>
After completion, create `.planning/phases/05-demo-readiness/05-04-SUMMARY.md`
</output>
