---
phase: 03-intelligence-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/intelligence/scenarios/types.ts
  - src/lib/intelligence/scenarios/calculator.ts
  - src/lib/intelligence/scenarios/analyzer.ts
  - src/app/api/scenarios/analyze/route.ts
  - src/app/scenario/page.tsx
  - src/app/scenario/loading.tsx
  - src/app/scenario/components/scenario-form.tsx
  - src/app/scenario/components/impact-display.tsx
  - src/lib/data/server/scenario-data.ts
  - src/components/ui/nav-bar.tsx
autonomous: true

must_haves:
  truths:
    - "User selects scenario type (financial, headcount, customer) and fills form with bounded numeric inputs"
    - "User submits scenario and sees before/after metric comparison table with positive/negative change indicators"
    - "User receives Claude-powered impact analysis with risk assessment and recommendation"
    - "Invalid inputs show inline validation errors with bounds messages (e.g., 'Max 50% price decrease')"
    - "Loading state shows during Claude analysis (2-5 seconds) with disabled submit button"
  artifacts:
    - path: "src/lib/intelligence/scenarios/types.ts"
      provides: "Zod schemas for financial/headcount/customer scenarios and Claude response validation"
      contains: "financialScenarioSchema"
    - path: "src/lib/intelligence/scenarios/calculator.ts"
      provides: "Before/after metric calculation using semantic resolver data"
      exports: ["ScenarioCalculator"]
    - path: "src/lib/intelligence/scenarios/analyzer.ts"
      provides: "Claude-powered scenario impact analysis"
      exports: ["analyzeScenarioWithClaude"]
    - path: "src/app/api/scenarios/analyze/route.ts"
      provides: "POST endpoint for scenario analysis"
      exports: ["POST"]
    - path: "src/app/scenario/page.tsx"
      provides: "Server Component page fetching baseline metrics"
    - path: "src/app/scenario/components/scenario-form.tsx"
      provides: "Client form with React Hook Form + Zod validation"
      contains: "use client"
    - path: "src/app/scenario/components/impact-display.tsx"
      provides: "Before/after comparison table with accessible change indicators"
      contains: "use client"
  key_links:
    - from: "src/app/scenario/components/scenario-form.tsx"
      to: "/api/scenarios/analyze"
      via: "fetch POST on form submit"
      pattern: "fetch.*api/scenarios/analyze"
    - from: "src/app/api/scenarios/analyze/route.ts"
      to: "src/lib/intelligence/scenarios/analyzer.ts"
      via: "analyzeScenarioWithClaude function call"
      pattern: "analyzeScenarioWithClaude"
    - from: "src/lib/intelligence/scenarios/analyzer.ts"
      to: "src/lib/intelligence/claude/orchestrator.ts"
      via: "getOrchestrator().processRequest()"
      pattern: "getOrchestrator"
    - from: "src/app/scenario/page.tsx"
      to: "src/lib/data/server/scenario-data.ts"
      via: "getBaselineMetrics() server-side data fetch"
      pattern: "getBaselineMetrics"
---

<objective>
Build scenario modeling feature: users select financial/headcount/customer scenario types, enter bounded parameters via validated forms, and receive before/after metric comparisons with Claude-powered impact analysis including risk assessment and recommendations.

Purpose: Enables executives to model what-if scenarios (pricing changes, hiring plans, customer churn) and instantly see financial impact with AI-powered analysis - replacing manual spreadsheet modeling.
Output: Working /scenario page with 3 scenario types, validated forms, impact comparison table, and Claude analysis.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-intelligence-features/03-RESEARCH.md

Key existing files to reference:
@src/lib/intelligence/claude/orchestrator.ts - ClaudeOrchestrator singleton, processRequest(), Result type returns
@src/lib/intelligence/claude/prompts/scenario-impact.ts - buildScenarioPrompt() and Scenario interface
@src/lib/semantic/schema/financial.ts - METRIC_DEFINITIONS with calculate functions
@src/lib/data/server/dashboard-data.ts - getDashboardData(), getBUSummaries() patterns
@src/lib/types/financial.ts - BU, BUEnum, FinancialMetrics types
@src/lib/types/result.ts - Result<T,E>, ok(), err()
@src/components/ui/nav-bar.tsx - Add Scenarios link
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scenario service layer (types, calculator, analyzer) and API route</name>
  <files>
    src/lib/intelligence/scenarios/types.ts
    src/lib/intelligence/scenarios/calculator.ts
    src/lib/intelligence/scenarios/analyzer.ts
    src/app/api/scenarios/analyze/route.ts
    src/lib/data/server/scenario-data.ts
  </files>
  <action>
    **1. Create `src/lib/intelligence/scenarios/types.ts`:**
    - Define Zod schemas with Federal Reserve-inspired bounds:
      - `financialScenarioSchema`: type literal 'financial', description (min 10 chars), pricingChange (-50 to +100), costChange (-30 to +100), targetMargin (0 to 100), affectedBU (Cloudsense|Kandy|STL|All optional, default 'All')
      - `headcountScenarioSchema`: type literal 'headcount', description, headcountChange (-20 to +50 integer), avgSalaryCost (50000 to 300000), affectedBU optional
      - `customerScenarioSchema`: type literal 'customer', description, churnRate (0 to 30%), acquisitionCount (0 to 50 integer), avgCustomerARR (10000 to 5000000), affectedBU optional
    - Define `scenarioInputSchema` as discriminated union: `z.discriminatedUnion('type', [financialScenarioSchema, headcountScenarioSchema, customerScenarioSchema])`
    - Define `ScenarioInput = z.infer<typeof scenarioInputSchema>`
    - Define `ImpactMetric` interface: { name: string, before: number, after: number, change: number, changePercent: number }
    - Define `scenarioImpactResponseSchema` (Zod) for Claude response validation:
      - impactSummary: string
      - affectedMetrics: array of { name, before, after, change, changePercent }
      - risks: array of { description, severity (HIGH|MEDIUM|LOW), likelihood (HIGH|MEDIUM|LOW), mitigation: string }
      - recommendation: enum APPROVE|APPROVE_WITH_CONDITIONS|REJECT
      - reasoning: string
      - conditions: string array
      - confidence: HIGH|MEDIUM|LOW
    - Export `ScenarioImpactResponse = z.infer<typeof scenarioImpactResponseSchema>`
    - Define `ScenarioResult` type: { input: ScenarioInput, calculatedMetrics: ImpactMetric[], claudeAnalysis: ScenarioImpactResponse | null, timestamp: Date }

    **2. Create `src/lib/intelligence/scenarios/calculator.ts`:**
    - Export class `ScenarioCalculator`
    - Method `calculate(input: ScenarioInput, baseline: BaselineMetrics): ImpactMetric[]`
    - For financial scenarios:
      - Calculate revenue impact: baseline.totalRevenue * (1 + pricingChange/100)
      - Calculate cost impact: baseline.totalCosts * (1 + costChange/100)
      - Derive new EBITDA, net margin, ARR from changed values
      - Return ImpactMetric[] for: Total Revenue, EBITDA, Net Margin, ARR
    - For headcount scenarios:
      - Calculate new headcount cost: baseline.headcountCost + (headcountChange * avgSalaryCost / 4) (quarterly)
      - Derive new total costs, EBITDA, net margin
      - Return ImpactMetric[] for: Headcount Cost, Total Costs, EBITDA, Net Margin
    - For customer scenarios:
      - Calculate churn impact: baseline.totalRR * (churnRate / 100)
      - Calculate acquisition impact: acquisitionCount * avgCustomerARR / 4 (quarterly)
      - Net RR change and cascading effects on revenue, margin
      - Return ImpactMetric[] for: Recurring Revenue, Customer Count, Total Revenue, Net Margin
    - Each ImpactMetric must include before, after, change, and changePercent values
    - Define `BaselineMetrics` interface: { totalRevenue, totalRR, totalNRR, ebitda, netMarginPct, headcount, headcountCost, totalCosts, customerCount } - import from scenario-data.ts

    **3. Create `src/lib/intelligence/scenarios/analyzer.ts`:**
    - Export async function `analyzeScenarioWithClaude(input: ScenarioInput, calculatedMetrics: ImpactMetric[], baseline: BaselineMetrics): Promise<Result<ScenarioImpactResponse>>`
    - Import `getOrchestrator` from `@/lib/intelligence/claude/orchestrator`
    - Import `buildScenarioPrompt` from `@/lib/intelligence/claude/prompts/scenario-impact`
    - Build prompt using buildScenarioPrompt with scenario parameters and baseline data
    - Call `getOrchestrator().processRequest({ prompt, priority: 'HIGH', maxTokens: 4096, temperature: 0.7 })`
    - Parse response.content as JSON, validate with `scenarioImpactResponseSchema.safeParse()`
    - If validation fails: return err() with descriptive message
    - If Claude unavailable (no API key): return `ok()` with a mock analysis object showing "Claude analysis unavailable - displaying calculated metrics only" as impactSummary with calculated metrics mapped into the response format
    - Return `ok(validatedResponse)`

    **4. Create `src/lib/data/server/scenario-data.ts`:**
    - Export `BaselineMetrics` interface (same as calculator needs): { totalRevenue, totalRR, totalNRR, ebitda, ebitdaTarget, netMarginPct, netMarginTarget, headcount, headcountCost, totalCosts, customerCount }
    - Export async function `getBaselineMetrics(): Promise<Result<BaselineMetrics>>`
    - Use `getDashboardData()` and `getBUSummaries()` from dashboard-data.ts to assemble baseline
    - Calculate headcountCost as totalRevenue * 0.08 (8% from CLAUDE.md cost structure)
    - Calculate totalCosts as totalRevenue * (1 - netMarginPct/100)
    - Return complete BaselineMetrics object

    **5. Create `src/app/api/scenarios/analyze/route.ts`:**
    - Export async POST handler
    - Parse request body with `scenarioInputSchema.safeParse()`
    - If validation fails: return 400 with Zod error messages
    - Call `getBaselineMetrics()` - if fails return 500
    - Create `ScenarioCalculator` and calculate metrics
    - Call `analyzeScenarioWithClaude()` for Claude analysis
    - Return JSON response: `{ calculatedMetrics: ImpactMetric[], claudeAnalysis: ScenarioImpactResponse | null, baseline: BaselineMetrics }`
    - All errors return appropriate HTTP status codes with error messages
  </action>
  <verify>
    Run `npx tsc --noEmit` from project root. All new files must compile without errors.
    Verify the API route file exports a POST function.
    Verify types.ts exports all three scenario schemas and the discriminated union.
  </verify>
  <done>
    Service layer compiles: ScenarioCalculator produces ImpactMetric[] for all 3 scenario types, analyzer calls Claude via orchestrator and validates response with Zod, API route accepts POST with scenario input and returns calculated + Claude analysis.
  </done>
</task>

<task type="auto">
  <name>Task 2: Scenario UI page with forms, impact display, and nav update</name>
  <files>
    src/app/scenario/page.tsx
    src/app/scenario/loading.tsx
    src/app/scenario/components/scenario-form.tsx
    src/app/scenario/components/impact-display.tsx
    src/components/ui/nav-bar.tsx
  </files>
  <action>
    **1. Create `src/app/scenario/loading.tsx`:**
    - Export default Loading component with Tailwind animate-pulse skeletons
    - Match pattern from src/app/dashboard/loading.tsx
    - Skeleton for scenario type selector, form fields, and impact area

    **2. Create `src/app/scenario/page.tsx`:**
    - Server Component (no 'use client')
    - Import `getBaselineMetrics` from `@/lib/data/server/scenario-data`
    - Fetch baseline metrics server-side
    - If baseline fetch fails: show error message with retry guidance
    - Wrap ScenarioForm in Suspense boundary with loading fallback
    - Pass baseline as prop to client ScenarioForm component
    - Page title: "Scenario Modeling" with subtitle "Model what-if scenarios and see financial impact"

    **3. Create `src/app/scenario/components/scenario-form.tsx`:**
    - 'use client' component
    - Install and import `react-hook-form` and `@hookform/resolvers/zod`
    - Props: `{ baseline: BaselineMetrics }`
    - State: selectedType ('financial' | 'headcount' | 'customer'), impact (ScenarioResult | null), analyzing (boolean)
    - Scenario type selector: 3 buttons/tabs styled with Tailwind (active state: bg-blue-600 text-white, inactive: bg-slate-100)
    - Render different form fields based on selectedType:
      - **Financial:** description (textarea), pricingChange (number input, step 0.1), costChange (number input, step 0.1), targetMargin (number input), affectedBU (select dropdown)
      - **Headcount:** description, headcountChange (number input, step 1), avgSalaryCost (number input, step 1000), affectedBU
      - **Customer:** description, churnRate (number input, step 0.1), acquisitionCount (number input, step 1), avgCustomerARR (number input, step 1000), affectedBU
    - Use React Hook Form with zodResolver for the selected scenario schema
    - Reset form when type changes (call `reset()` from useForm)
    - On submit: call `fetch('/api/scenarios/analyze', { method: 'POST', body: JSON.stringify(formData) })`
    - Set analyzing=true during request, false after
    - On success: set impact state and render ImpactDisplay
    - On error: use `toast.error()` from sonner
    - Submit button: "Analyze Impact" / "Analyzing..." (disabled when analyzing)
    - All form labels use htmlFor with matching id attributes
    - All error messages in `<p className="mt-1 text-sm text-red-600">`
    - Default values: pricingChange=0, costChange=0, targetMargin=baseline.netMarginTarget, headcountChange=0, avgSalaryCost=150000, churnRate=0, acquisitionCount=0, avgCustomerARR=100000

    **4. Create `src/app/scenario/components/impact-display.tsx`:**
    - 'use client' component
    - Props: `{ calculatedMetrics: ImpactMetric[], claudeAnalysis: ScenarioImpactResponse | null }`
    - **Metrics comparison table:**
      - Columns: Metric | Current | Projected | Change | % Change
      - Format currency values with $ and commas (Intl.NumberFormat)
      - Change column: green text + up arrow for positive, red text + down arrow for negative
      - ACCESSIBILITY: color + icon + sr-only text (never color alone) following Plan 02 pattern
      - Use aria-label on change cells (e.g., "Increased by $500,000")
    - **Claude Analysis section** (if claudeAnalysis not null):
      - Impact Summary card with text
      - Recommendation badge: APPROVE (green), APPROVE_WITH_CONDITIONS (yellow), REJECT (red) - with icon + text
      - Confidence badge (HIGH/MEDIUM/LOW)
      - Risks list: each risk shows severity badge + description + mitigation
      - Conditions list (if APPROVE_WITH_CONDITIONS)
      - Reasoning paragraph
    - If claudeAnalysis is null: show "Claude analysis unavailable" info message with gray background

    **5. Update `src/components/ui/nav-bar.tsx`:**
    - Add `{ href: '/scenario', label: 'Scenarios' }` to the links array (after 'Alerts')
    - Add `{ href: '/query', label: 'Ask' }` to the links array (after 'Scenarios') - preparing for Plan 03-02
  </action>
  <verify>
    Run `npx tsc --noEmit` - all new components compile without errors.
    Run `npm run build` to verify Next.js can build the scenario route.
    Verify nav-bar.tsx has 5 links: Dashboard, Accounts, Alerts, Scenarios, Ask.
  </verify>
  <done>
    User navigates to /scenario, sees scenario type selector (financial/headcount/customer), fills form with validated inputs (bounds-checked), submits and sees before/after comparison table with accessible change indicators. Claude analysis section shows impact summary, recommendation, risks, and confidence. Nav bar updated with Scenarios and Ask links.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` completes successfully
3. Navigate to /scenario - page loads with scenario type selector
4. Select "Financial" - form shows pricing change, cost change, target margin, BU selector
5. Enter invalid value (e.g., pricingChange=200) - see inline validation error
6. Submit valid scenario - loading state appears, then impact comparison table renders
7. Impact table shows before/after with green/red indicators (+ icons for accessibility)
8. Claude analysis section shows or "unavailable" message renders gracefully
9. Nav bar shows all 5 links: Dashboard, Accounts, Alerts, Scenarios, Ask
</verification>

<success_criteria>
- All 3 scenario types (financial, headcount, customer) have working forms with bounded inputs
- Before/after metric comparison table displays for all scenario types
- Claude-powered analysis integrates via existing orchestrator (graceful fallback if no API key)
- WCAG 2.2 AA compliant: all status indicators use color + icon + text + aria-label
- Page loads within 2 seconds (server-side baseline fetch, client form interaction)
</success_criteria>

<output>
After completion, create `.planning/phases/03-intelligence-features/03-01-SUMMARY.md`
</output>
