---
phase: 04-advanced-account-intelligence
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/app/accounts/[name]/page.tsx
  - src/app/accounts/[name]/loading.tsx
  - src/app/accounts/[name]/_components/tab-navigation.tsx
  - src/app/accounts/[name]/_components/overview-tab.tsx
  - src/app/accounts/[name]/_components/financials-tab.tsx
  - src/app/accounts/[name]/_components/strategy-tab.tsx
  - src/app/accounts/[name]/_components/competitive-tab.tsx
  - src/app/accounts/components/account-table.tsx
  - src/components/ui/nav-bar.tsx
autonomous: true

must_haves:
  truths:
    - "User clicks a customer name in the account table and navigates to their account plan page"
    - "User sees horizontal tab bar with all 7 tab names and can switch between them"
    - "User views account overview with health score, quick metrics, and executive summary"
    - "User views financial details (ARR, NRR, margin) for the account"
    - "User tracks pain points and opportunities with status indicators on the Strategy tab"
    - "User views competitive intelligence showing our competitors and customer's competitors"
    - "Tabs persist in URL (bookmarkable, shareable)"
    - "Mobile users see dropdown tab selector instead of horizontal tabs"
  artifacts:
    - path: "src/app/accounts/[name]/page.tsx"
      provides: "Account plan page with tab routing via searchParams"
      min_lines: 40
    - path: "src/app/accounts/[name]/_components/tab-navigation.tsx"
      provides: "Horizontal tabs (desktop) / dropdown (mobile) with URL-based state"
      exports: ["TabNavigation"]
    - path: "src/app/accounts/[name]/_components/overview-tab.tsx"
      provides: "Account overview with health, metrics, and summary"
      exports: ["OverviewTab"]
    - path: "src/app/accounts/[name]/_components/strategy-tab.tsx"
      provides: "Pain points and opportunities cards with status badges"
      exports: ["StrategyTab"]
    - path: "src/app/accounts/[name]/_components/competitive-tab.tsx"
      provides: "Two-column competitor cards with strengths/weaknesses"
      exports: ["CompetitiveTab"]
  key_links:
    - from: "src/app/accounts/[name]/page.tsx"
      to: "src/lib/data/server/account-plan-data.ts"
      via: "getAccountPlanData call"
      pattern: "getAccountPlanData"
    - from: "src/app/accounts/components/account-table.tsx"
      to: "src/app/accounts/[name]/page.tsx"
      via: "Next.js Link to /accounts/{name}"
      pattern: "href.*accounts/"
    - from: "src/app/accounts/[name]/_components/tab-navigation.tsx"
      to: "URL searchParams"
      via: "useSearchParams + router.push"
      pattern: "useSearchParams|searchParams"
---

<objective>
Build the account plan page shell with tab navigation and implement 4 simpler tabs: Overview, Financials, Strategy, and Competitive.

Purpose: This creates the foundation page that users navigate to from the account directory. The 4 tabs built here are straightforward card layouts reusing existing components and data, covering requirements ACCT-05, ACCT-09, ACCT-10.

Output: Account detail page at `/accounts/[name]?tab=overview` with 4 functional tabs and clickable rows in the account table.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-advanced-account-intelligence/04-01-SUMMARY.md
@src/app/accounts/page.tsx
@src/app/accounts/components/account-table.tsx
@src/components/ui/nav-bar.tsx
@src/components/ui/health-indicator.tsx
@src/components/ui/badge.tsx
@src/components/ui/card.tsx
@src/lib/data/server/account-data.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create account plan page with tab navigation and link from account table</name>
  <files>
    src/app/accounts/[name]/page.tsx
    src/app/accounts/[name]/loading.tsx
    src/app/accounts/[name]/_components/tab-navigation.tsx
    src/app/accounts/components/account-table.tsx
  </files>
  <action>
**1a. Create TabNavigation client component** at `src/app/accounts/[name]/_components/tab-navigation.tsx`:

- "use client" component
- Uses `useSearchParams()` and `useRouter()` from next/navigation
- 7 tabs: overview, financials, organization, strategy, competitive, intelligence, action-items
- Tab labels: Overview, Financials, Organization, Strategy, Competitive, Intelligence, Action Items
- Desktop (md+): Horizontal tab bar with `border-b`, active tab has `border-b-2 border-blue-600 text-blue-600`, inactive is `text-slate-600 hover:text-slate-900`
- Mobile (below md): `<select>` dropdown with same tab options
- On tab change: `router.push(\`/accounts/\${accountName}?tab=\${tab}\`, { scroll: false })` (scroll: false prevents page jump)
- Props: `accountName: string` (the URL-encoded name)
- Active tab from: `searchParams.get('tab') || 'overview'`
- Wrap `useSearchParams()` in Suspense (Next.js 15 requirement) - use a wrapper pattern where the parent provides the fallback

**1b. Create account plan page** at `src/app/accounts/[name]/page.tsx`:

- Server Component
- Route params: `{ params: { name: string } }` - this is the URL-encoded customer name
- SearchParams: `{ searchParams: { tab?: string } }` - active tab
- Decode customer name: `decodeURIComponent(params.name)` to get the actual customer name
- Fetch data: Call `getAccountPlanData(customerName)` from `@/lib/data/server/account-plan-data`
- Also call `getAllCustomersWithHealth()` from `@/lib/data/server/account-data` to get the specific customer's financial data and health score (find by customer_name match)
- Render: Header with customer name + BU badge + health indicator, then TabNavigation, then conditional tab content based on searchParams.tab
- Tab content rendered via conditional: `{activeTab === 'overview' && <OverviewTab ... />}` etc.
- For tabs not yet built (organization, intelligence, action-items), render a placeholder: `<div className="text-center py-12 text-slate-500">Coming soon</div>`
- Wrap each tab in Suspense with TabSkeleton fallback (animated-pulse cards)
- Include metadata: `export function generateMetadata({ params }) { return { title: \`\${decodeURIComponent(params.name)} - Account Plan\` } }`
- Back link to /accounts at top of page

**1c. Create loading skeleton** at `src/app/accounts/[name]/loading.tsx`:
- Animate-pulse skeleton matching page layout (header + tab bar + content area)

**1d. Make account table rows clickable** - modify `src/app/accounts/components/account-table.tsx`:
- Import `Link` from `next/link`
- Wrap the customer_name cell content in a `<Link href={\`/accounts/\${encodeURIComponent(row.original.customer_name)}\`}>` with blue text and hover:underline styling
- Keep existing table structure intact, only modify the customer_name column cell renderer

IMPORTANT: Do NOT modify the nav-bar.tsx yet - the /accounts link already exists and the route `/accounts/[name]` will be a sub-route that inherits the active state.

Note on Next.js 16 params: In Next.js 16 (which this project uses - see package.json), `params` and `searchParams` are Promises. The page component should be `async function AccountPlanPage({ params, searchParams })` and use `const { name } = await params` and `const { tab } = await searchParams`.
  </action>
  <verify>
Run `npx tsc --noEmit` - zero errors. Dev server starts without errors: `npm run dev`. Navigate to `/accounts` and verify customer names are clickable links. Click a customer name and verify the URL is `/accounts/{encoded-name}?tab=overview`. Verify tab bar renders with 7 tabs. Verify clicking tabs changes URL parameter.
  </verify>
  <done>Account plan page renders at /accounts/[name] with 7-tab navigation (URL-persisted). Customer names in account table are clickable links to account plan page. Mobile shows dropdown, desktop shows horizontal tabs.</done>
</task>

<task type="auto">
  <name>Task 2: Build Overview, Financials, Strategy, and Competitive tab content</name>
  <files>
    src/app/accounts/[name]/_components/overview-tab.tsx
    src/app/accounts/[name]/_components/financials-tab.tsx
    src/app/accounts/[name]/_components/strategy-tab.tsx
    src/app/accounts/[name]/_components/competitive-tab.tsx
  </files>
  <action>
**2a. OverviewTab** (`overview-tab.tsx`) - Server Component:
- Props: customer (CustomerWithHealth), intelligence report (raw markdown string or null)
- Layout: Top row with 4 KPI cards (reuse KPICard component): ARR (rr * 4), Total Revenue, Health Score, Subscription Count
- Below: Two-column grid. Left: "Account Summary" card showing customer_name, BU, rank, pct_of_total. Right: "Quick Intelligence" card showing first ~500 chars of intelligence report markdown (truncated with "View full report on Intelligence tab" link). If no intelligence report, show empty state "No intelligence report available".
- Below: "Health Factors" card listing healthFactors array as bullet points with appropriate icons
- Use existing Card component from `@/components/ui/card`
- Use existing HealthIndicator and Badge components

**2b. FinancialsTab** (`financials-tab.tsx`) - Server Component:
- Props: customer (CustomerWithHealth)
- Layout: KPI row with 4 cards: Recurring Revenue (rr), Non-Recurring Revenue (nrr), Total Revenue (total), ARR (rr * 4)
- Below: "Subscriptions" table listing all subscriptions from customer.subscriptions array
- Table columns: Sub ID, ARR, Renewal Quarter, Will Renew (with color-coded badge: green for "Yes", red for "No", yellow for "TBD" and other values), Projected ARR
- Format currency values with `$` and comma separators (toLocaleString)
- Below table: "Revenue Breakdown" section showing RR as % of total, NRR as % of total with a simple horizontal stacked bar (CSS only, no chart library needed - use two adjacent divs with percentage widths and bg-blue-500/bg-amber-500)

**2c. StrategyTab** (`strategy-tab.tsx`) - Server Component:
- Props: painPoints (PainPoint[]), opportunities (Opportunity[])
- Two-column responsive grid (md:grid-cols-2, single column on mobile)
- Left column: "Pain Points" heading with count badge
  - Cards for each pain point with: title (font-semibold), description (text-sm text-slate-600), severity badge (red/yellow/green with icons per WCAG - same pattern as health indicator), status badge (active=blue, monitoring=amber, resolved=green)
  - If empty: "No pain points tracked yet" with subtle illustration
- Right column: "Opportunities" heading with count badge
  - Cards for each opportunity with: title, description, status badge (identified=gray, exploring=blue, proposed=amber, won=green, lost=red), estimated value in $K format, probability as percentage
  - If empty: "No opportunities identified yet"
- All badges use color + icon (never color alone) for WCAG 2.2 Level AA

**2d. CompetitiveTab** (`competitive-tab.tsx`) - Server Component:
- Props: competitors (Competitor[])
- Split competitors: ourCompetitors = type 'our-competitor' or 'both', customerCompetitors = type 'customer-competitor' or 'both'
- Two-column responsive grid
- Left: "Competing for This Account" heading - cards showing companies competing with Skyvera
- Right: "Customer's Market Competitors" heading - cards showing the customer's industry rivals
- Each CompetitorCard: name (bold), description (text-sm), two-column inner grid with Strengths (green text, bullet list) and Weaknesses (red text, bullet list), lastUpdated timestamp
- If no competitors: "No competitive intelligence available" empty state
- Bottom section: "Competitive Summary" card with total count and breakdown by type
  </action>
  <verify>
Run `npx tsc --noEmit` - zero errors. Navigate to a hero account (e.g., `/accounts/British%20Telecommunications%20plc?tab=overview`). Verify Overview shows KPIs, health factors, and intelligence snippet. Switch to Financials - verify subscription table renders. Switch to Strategy - verify pain points and opportunities cards with status badges. Switch to Competitive - verify two-column competitor layout. Navigate to a non-hero account and verify empty states render gracefully.
  </verify>
  <done>4 tabs render with correct data for hero accounts and empty states for other accounts. All tabs use accessible color + icon patterns. Financial metrics display correctly. Strategy cards show status indicators. Competitor intelligence shows dual perspectives.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Account table customer names are clickable links
3. Account plan page renders with 7-tab navigation
4. Tab state persists in URL (bookmarkable)
5. Overview tab shows KPIs, health, intelligence snippet
6. Financials tab shows subscription table and revenue breakdown
7. Strategy tab shows pain points and opportunities with status badges
8. Competitive tab shows two-column competitor layout
9. Non-hero accounts show graceful empty states
10. Mobile viewport shows dropdown tab selector
</verification>

<success_criteria>
- Users can navigate from account directory to individual account plans (ACCT-09 partial)
- Pain points and opportunities visible with status indicators (ACCT-05)
- Competitive intelligence shows dual perspectives (ACCT-10)
- 7-tab interface navigable with URL-persisted state (ACCT-09)
- All 4 tabs render correctly for hero accounts and gracefully for empty accounts
</success_criteria>

<output>
After completion, create `.planning/phases/04-advanced-account-intelligence/04-02-SUMMARY.md`
</output>
