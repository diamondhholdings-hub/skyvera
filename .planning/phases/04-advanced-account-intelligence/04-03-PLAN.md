---
phase: 04-advanced-account-intelligence
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - src/app/accounts/[name]/_components/organization-tab.tsx
  - src/app/accounts/[name]/_components/stakeholder-card.tsx
  - src/app/accounts/[name]/_components/intelligence-tab.tsx
  - src/app/accounts/[name]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User views organization structure as a tree with reporting lines"
    - "User sees full stakeholder profile cards with name, title, role, RACI, contact info, and relationship strength"
    - "User can click to edit stakeholder cards inline (edit mode with save/cancel)"
    - "User views intelligence cards (Opportunities, Risks, Recommendations) as separate sections"
    - "User sees news timeline with sentiment badges (positive/neutral/negative)"
    - "User sees stale data warning when intelligence data is unavailable"
  artifacts:
    - path: "src/app/accounts/[name]/_components/organization-tab.tsx"
      provides: "Org chart tree view with stakeholder hierarchy"
      exports: ["OrganizationTab"]
    - path: "src/app/accounts/[name]/_components/stakeholder-card.tsx"
      provides: "Stakeholder card with inline editing and dual role display"
      exports: ["StakeholderCard"]
    - path: "src/app/accounts/[name]/_components/intelligence-tab.tsx"
      provides: "Intelligence cards and news timeline with sentiment"
      exports: ["IntelligenceTab"]
  key_links:
    - from: "src/app/accounts/[name]/_components/organization-tab.tsx"
      to: "stakeholder-card.tsx"
      via: "recursive tree rendering"
      pattern: "StakeholderCard"
    - from: "src/app/accounts/[name]/_components/intelligence-tab.tsx"
      to: "data/intelligence/reports"
      via: "getIntelligenceReport from account-plan-data"
      pattern: "getIntelligenceReport|intelligence"
    - from: "src/app/accounts/[name]/page.tsx"
      to: "OrganizationTab and IntelligenceTab"
      via: "conditional tab rendering"
      pattern: "organization.*OrganizationTab|intelligence.*IntelligenceTab"
---

<objective>
Build the Organization tab (org chart with stakeholder cards) and Intelligence tab (insights cards + news timeline) to complete the information-display tabs.

Purpose: These two tabs require more complex rendering (tree structures, markdown parsing, sentiment display) but are still read-heavy. Covers requirements ACCT-04, ACCT-07, ACCT-08.

Output: Organization tab with tree view and inline-editable stakeholder cards. Intelligence tab with structured insights and news timeline.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-advanced-account-intelligence/04-01-SUMMARY.md
@.planning/phases/04-advanced-account-intelligence/04-02-SUMMARY.md
@src/app/accounts/[name]/page.tsx
@src/lib/types/account-plan.ts
@src/lib/data/server/account-plan-data.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build Organization tab with CSS-based org tree and stakeholder cards</name>
  <files>
    src/app/accounts/[name]/_components/organization-tab.tsx
    src/app/accounts/[name]/_components/stakeholder-card.tsx
  </files>
  <action>
**Do NOT install react-organizational-chart** - use pure CSS org tree instead. React 19 compatibility is uncertain and adding a dependency for a simple tree is unnecessary. CSS-only trees are more reliable and customizable.

**1a. StakeholderCard** (`stakeholder-card.tsx`) - "use client" component:

Props: `stakeholder: Stakeholder`, `onUpdate?: (updated: Stakeholder) => void`

**View mode** (default):
- Card: `bg-white p-4 rounded-lg shadow hover:shadow-md w-64 cursor-pointer` with `onClick={() => setIsEditing(true)}`
- Top row: Name (font-semibold) + primary role badge (color-coded per role: decision-maker=purple, influencer=blue, champion=green, user=gray, blocker=red) + RACI badge if present (smaller, gray bg, shows first letter uppercase e.g., "A" for accountable)
- Title: text-sm text-slate-600
- Contact section (text-xs text-slate-500): email, phone (only if present)
- Relationship strength indicator: colored dot (strong=green, moderate=amber, weak=red, unknown=gray) + text label + accessible aria-label
- Last interaction: relative date using date-fns formatDistanceToNow (if present)
- Notes: truncated to 2 lines with text-xs if present
- Use lucide-react icons: Mail, Phone, Clock, MessageSquare

**Edit mode** (when isEditing=true):
- Same card dimensions but with border-2 border-blue-500
- Editable fields: name (input), title (input), role (select dropdown), raciRole (select dropdown), email (input), phone (input), relationshipStrength (select), notes (textarea 2 rows)
- Bottom: Save button (bg-blue-600 text-white) + Cancel button (text-slate-600)
- Save calls onUpdate prop with updated stakeholder data and exits edit mode
- Cancel reverts to original data and exits edit mode
- For demo: onUpdate is a no-op (data persists in component state only, not to disk). This is acceptable for the demo.

**1b. OrganizationTab** (`organization-tab.tsx`) - Mix of server wrapper + client component:

The tab itself can be a client component since it manages inline editing state.

Props: `stakeholders: Stakeholder[]`

**Tree building logic:**
- Find root: stakeholder with no `reportsTo` (or `reportsTo` not matching any other stakeholder ID)
- If multiple roots (no reportsTo), show them side by side
- Recursive function `buildTree(parentId)`: find all stakeholders where `reportsTo === parentId`, render each as StakeholderCard with their children below

**CSS org tree layout:**
- Use CSS flexbox for horizontal layout at each level
- Connector lines using CSS `::before` and `::after` pseudo-elements:
  - Vertical line from parent bottom to children top: `border-left: 2px solid #CBD5E1` (slate-300)
  - Horizontal line connecting siblings: `border-top: 2px solid #CBD5E1`
- Tree node wrapper: `relative flex flex-col items-center`
- Children container: `flex gap-8 pt-8 relative` (pt-8 gives space for connector lines)
- Use Tailwind CSS with `before:` and `after:` pseudo-element utilities, OR use a small CSS module / inline styles for connector lines (Tailwind pseudo-element utilities may not be sufficient for complex connectors - fallback to inline styles)

**Alternative if tree CSS is too complex:** Fall back to an indented list view:
- Each level indented by 24px
- Connector: `border-l-2 border-slate-300` on the left side
- This is simpler and still clearly shows hierarchy

**Empty state:** "No stakeholders mapped yet" + muted text suggesting to add stakeholder data

**Summary section at bottom:**
- Total stakeholders count
- Role breakdown: "2 Decision Makers, 1 Influencer, 1 Champion, 1 User"
- Relationship health: "3 Strong, 1 Moderate, 1 Weak"
  </action>
  <verify>
Run `npx tsc --noEmit` - zero errors. Navigate to `/accounts/British%20Telecommunications%20plc?tab=organization`. Verify stakeholder cards render in a tree/hierarchy. Verify role badges and RACI indicators display. Click a card to verify edit mode activates. Verify save/cancel buttons work. Navigate to a non-hero account and verify empty state.
  </verify>
  <done>Organization tab shows stakeholder hierarchy with profile cards. Cards have dual role display (primary + RACI). Inline editing works with save/cancel. Empty state for accounts without stakeholder data.</done>
</task>

<task type="auto">
  <name>Task 2: Build Intelligence tab with insight cards and news timeline</name>
  <files>
    src/app/accounts/[name]/_components/intelligence-tab.tsx
    src/app/accounts/[name]/page.tsx
  </files>
  <action>
**2a. IntelligenceTab** (`intelligence-tab.tsx`) - Server Component:

Props: `intelligenceReport: { raw: string, structured?: IntelligenceReport } | null`, `news: { articles: Array<{title, url, source, published, summary, relevance_score}> } | null`, `customerName: string`

**Intelligence Report section:**

If structured intelligence data is available (the data access function in 04-01 parses markdown into structured format), render 3 cards in a responsive grid (md:grid-cols-3):

1. **Opportunities card** (light green bg-green-50 border): Title "Opportunities" with lightbulb icon (lucide Lightbulb). List each opportunity as bullet point with title (bold), description (text-sm), estimated value if present ($XXK format), confidence badge.

2. **Risks card** (light red bg-red-50 border): Title "Risks" with AlertTriangle icon. List each risk with title, description, severity badge (HIGH=red, MEDIUM=amber, LOW=green), mitigation text in blue.

3. **Recommendations card** (light blue bg-blue-50 border): Title "Recommendations" with Target icon. List each recommendation with title, description, priority badge, next steps as nested bullet list.

If structured data is NOT available but raw markdown IS available:
- Render the raw markdown in a prose-styled div with `whitespace-pre-wrap` and basic markdown-like formatting
- Add a note: "Full intelligence report - parsed from account analysis"
- Truncate to first 2000 characters with "Read more..." expandable section (useState toggle)

If NEITHER available:
- Stale data warning component: amber bg-amber-50 border-2 border-amber-200, AlertTriangle icon, "No intelligence report available for this account" message

**News Timeline section:**

Below the intelligence cards, render "Recent News & Intelligence" heading.

If news articles exist (articles array has items):
- Render each article as a card in a vertical list (space-y-3)
- Each NewsArticleCard shows:
  - Title as a link (text-blue-600 hover:underline, opens in new tab with target="_blank" rel="noopener noreferrer")
  - Source and published date on same line (text-xs text-slate-500, separated by bullet)
  - Summary text (text-sm text-slate-600) - note: existing news summaries may contain HTML `<a>` tags - strip HTML tags before rendering (simple regex: `summary.replace(/<[^>]*>/g, '')` and truncate to 200 chars)
  - Sentiment badge (if derivable): positive=green pill, neutral=gray pill, negative=red pill. Note: existing news data does NOT have a sentiment field - skip sentiment badges for now unless the intelligence report provides sentiment context
  - Relevance score as subtle indicator if > 0.8

If no news articles:
- "No recent news available" with suggestion text

**2b. Wire into page** - update `src/app/accounts/[name]/page.tsx`:

Replace the placeholder divs for 'organization' and 'intelligence' tabs with actual components:
- `{activeTab === 'organization' && <OrganizationTab stakeholders={planData.stakeholders} />}`
- `{activeTab === 'intelligence' && <IntelligenceTab intelligenceReport={planData.intelligence} news={planData.news} customerName={customerName} />}`

Import both components. Keep 'action-items' as placeholder (built in Plan 04-04).
  </action>
  <verify>
Run `npx tsc --noEmit` - zero errors. Navigate to `/accounts/British%20Telecommunications%20plc?tab=intelligence`. Verify intelligence cards render (Opportunities, Risks, Recommendations) or raw markdown displays. Verify news timeline shows articles from data/news/ if available. Navigate to an account without intelligence data and verify graceful fallback. Verify `/accounts/British%20Telecommunications%20plc?tab=organization` also works (from Task 1).
  </verify>
  <done>Intelligence tab shows structured insight cards or raw markdown report. News timeline displays articles with source attribution. Stale/missing data handled gracefully. Both Organization and Intelligence tabs wired into main page component.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Organization tab shows stakeholder tree for hero accounts
3. Stakeholder cards show role badges, RACI indicators, contact info
4. Inline editing activates on card click, save/cancel work
5. Intelligence tab shows insight cards (Opportunities, Risks, Recommendations)
6. News timeline shows articles with links and source info
7. Missing data for any tab shows appropriate empty state
8. All 6 tabs now functional (overview, financials, organization, strategy, competitive, intelligence)
9. Only action-items tab remains as placeholder
</verification>

<success_criteria>
- Organization structure visible with stakeholder mapping and role definitions (ACCT-04)
- Claude-generated strategic insights displayed per account (ACCT-07)
- Real-time news and intelligence visible for customer companies (ACCT-08)
- All cards use accessible patterns (color + icon, never color alone)
- 6 of 7 tabs fully functional
</success_criteria>

<output>
After completion, create `.planning/phases/04-advanced-account-intelligence/04-03-SUMMARY.md`
</output>
