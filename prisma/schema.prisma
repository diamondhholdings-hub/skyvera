generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Customer {
  id            Int            @id @default(autoincrement())
  customerName  String         @unique
  bu            String
  rr            Float
  nrr           Float
  totalRevenue  Float
  rank          Int?
  pctOfTotal    Float?
  healthScore   String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  subscriptions Subscription[]

  @@index([bu])
  @@index([customerName])
}

model Subscription {
  id           Int      @id @default(autoincrement())
  customerId   Int
  subId        Float?
  arr          Float?
  renewalQtr   String?
  willRenew    String?
  projectedArr Float?
  customer     Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
}

model FinancialSnapshot {
  id           Int      @id @default(autoincrement())
  bu           String
  quarter      String
  totalRR      Float
  totalNRR     Float
  totalRevenue Float
  grossMargin  Float
  netMargin    Float
  ebitda       Float
  createdAt    DateTime @default(now())

  @@unique([bu, quarter])
  @@index([bu])
  @@index([quarter])
}

model NewsArticle {
  id             Int      @id @default(autoincrement())
  customerName   String
  title          String
  summary        String
  publishedAt    DateTime
  source         String
  url            String
  sentiment      String?
  relevanceScore Float?
  fetchedAt      DateTime

  @@index([customerName])
  @@index([publishedAt])
}

model CacheEntry {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([expiresAt])
}

// Product Agent System Models

// PRD (Product Requirements Document)
model PRD {
  id                       Int      @id @default(autoincrement())
  prdId                    String   @unique // PRD-2026-042
  title                    String
  content                  String   // Markdown content (14 sections)

  // Scoring
  confidenceScore          Int      // 0-100 from QA validation
  priorityScore            Int      // 0-100 weighted multi-factor
  priorityClass            String   // P0/P1/P2/P3/P4
  leverageClassification   String   // Leverage/Neutral/Overhead

  // Business metrics
  arrImpact                Float
  customerCount            Int
  implementationWeeks      Int

  // Status
  status                   String   // Auto-Published/Pending Review/Approved/In Dev/Shipped/Rejected
  workflowId               String?

  // Metadata
  generatedAt              DateTime @default(now())
  reviewedAt               DateTime?
  approvedAt               DateTime?
  shippedAt                DateTime?

  // Assignments
  assignedPm               String?
  assignedEngLead          String?
  reviewedBy               String?
  approvedBy               String?

  // Tags (JSON arrays stored as strings)
  strategicThemes          String?  // JSON array
  businessUnits            String?  // JSON array
  customerTags             String?  // JSON array
  category                 String?

  // Relationships
  featureRequests          FeatureRequest[]
  lifecycle                PRDLifecycle?

  @@index([prdId])
  @@index([status])
  @@index([priorityClass])
  @@index([generatedAt])
}

// Feature Request from sales/customers
model FeatureRequest {
  id                 Int      @id @default(autoincrement())
  requestId          String   @unique @default(cuid())

  // Customer info
  customerName       String
  customerArr        Float
  businessUnit       String

  // Request details
  featureDescription String
  customerQuote      String?
  urgency            String   // critical/high/medium/low
  dealImpact         String   // hard_blocker/soft_blocker/friction/nice_to_have
  dealSize           Float?

  // Submission
  submittedBy        String
  submittedAt        DateTime @default(now())

  // Status
  status             String   // Submitted/Under Review/PRD Created/In Dev/Shipped/Declined
  linkedPrdId        String?
  linkedPrd          PRD?     @relation(fields: [linkedPrdId], references: [prdId])

  // Agent processing
  processedAt        DateTime?
  patternId          String?

  @@index([customerName])
  @@index([status])
  @@index([submittedAt])
  @@index([patternId])
}

// Detected patterns from Pattern Detection Agent
model Pattern {
  id              Int      @id @default(autoincrement())
  patternId       String   @unique @default(cuid())

  // Pattern details
  name            String
  description     String
  signal          String   // What triggered this pattern
  confidence      Float    // 0-1

  // Affected customers (JSON array)
  customers       String   // JSON array of customer names

  // Financial impact
  arrAtRisk       Float?
  arrOpportunity  Float?
  financialImpact Float?

  // Status
  status          String   // Detected/Analyzing/PRD Generated/Dismissed
  prdGenerated    Boolean  @default(false)
  linkedPrdId     String?

  // Metadata
  detectedAt      DateTime @default(now())
  processedAt     DateTime?

  @@index([patternId])
  @@index([status])
  @@index([detectedAt])
}

// Workflow execution tracking
model Workflow {
  id           Int      @id @default(autoincrement())
  workflowId   String   @unique @default(cuid())

  // Workflow details
  type         String   // prd_generation/pattern_analysis
  status       String   // pending/running/completed/failed
  currentStage String?

  // Tracking
  startedAt    DateTime @default(now())
  completedAt  DateTime?

  // Results (JSON)
  input        String?  // JSON
  output       String?  // JSON
  error        String?

  // Metrics
  executionTimeMs Int?
  tokensUsed      Int?
  costUsd         Float?

  @@index([workflowId])
  @@index([status])
  @@index([startedAt])
}

// PRD Lifecycle tracking for learning
model PRDLifecycle {
  id          Int      @id @default(autoincrement())
  prdId       String   @unique
  prd         PRD      @relation(fields: [prdId], references: [prdId])

  // Predictions
  predictedArrImpact     Float
  predictedCustomers     Int
  predictedWeeks         Int

  // Review metrics
  reviewDecision         String?  // approved/rejected/needs_revision
  reviewFeedback         String?
  pmPriorityOverride     Int?

  // Development metrics
  devStartedAt           DateTime?
  actualWeeks            Int?

  // Impact metrics (post-launch)
  actualArrImpact30d     Float?
  actualArrImpact90d     Float?
  actualCustomerAdoption Int?
  customerSatisfaction   Float?   // NPS score

  // Learning metrics
  predictionAccuracy     Float?
  leverageValidated      Boolean?

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([prdId])
}

// Conversational Scenario System

// Scenario Conversation Session
model ScenarioConversation {
  id               Int                      @id @default(autoincrement())
  conversationId   String                   @unique @default(cuid())

  // Session info
  title            String?                  // Auto-generated from first message
  status           String                   // active/completed/archived

  // Current scenario state (JSON)
  currentScenario  String?                  // JSON representation of current scenario
  scenarioType     String?                  // financial/headcount/customer/custom

  // Conversation metadata
  messageCount     Int                      @default(0)
  iterationCount   Int                      @default(0)

  // Results tracking
  finalRecommendation String?               // APPROVE/APPROVE_WITH_CONDITIONS/REJECT
  wasImplemented      Boolean               @default(false)
  implementedAt       DateTime?

  // Timestamps
  createdAt        DateTime                 @default(now())
  updatedAt        DateTime                 @updatedAt
  lastMessageAt    DateTime                 @default(now())

  // Relationships
  messages         ScenarioMessage[]
  versions         ScenarioVersion[]

  @@index([conversationId])
  @@index([status])
  @@index([createdAt])
  @@index([lastMessageAt])
}

// Individual messages in a conversation
model ScenarioMessage {
  id               Int                   @id @default(autoincrement())
  conversationId   String
  conversation     ScenarioConversation  @relation(fields: [conversationId], references: [conversationId], onDelete: Cascade)

  // Message details
  role             String                // user/assistant/system
  content          String                // Message text

  // Context
  messageType      String                // query/clarification/refinement/analysis/confirmation

  // AI metadata (for assistant messages)
  promptUsed       String?               // Prompt template used
  tokensUsed       Int?
  confidence       String?               // HIGH/MEDIUM/LOW

  // Attachments (JSON)
  attachments      String?               // JSON array of calculations, charts, etc.

  // Timestamps
  createdAt        DateTime              @default(now())

  @@index([conversationId])
  @@index([createdAt])
}

// Scenario versions (as conversation iterates)
model ScenarioVersion {
  id               Int                   @id @default(autoincrement())
  conversationId   String
  conversation     ScenarioConversation  @relation(fields: [conversationId], references: [conversationId], onDelete: Cascade)

  versionNumber    Int                   // 1, 2, 3...

  // Scenario definition (JSON)
  scenarioData     String                // Complete scenario parameters
  scenarioType     String                // financial/headcount/customer/custom

  // Results (JSON)
  calculatedMetrics String               // Impact metrics
  claudeAnalysis    String?              // AI analysis

  // Comparison to baseline
  impactSummary    String?
  keyChanges       String?               // JSON array of key changes

  // Version metadata
  label            String?               // "Initial", "After price adjustment", etc.
  notes            String?

  createdAt        DateTime              @default(now())

  @@unique([conversationId, versionNumber])
  @@index([conversationId])
  @@index([createdAt])
}

// Scenario templates for quick starts
model ScenarioTemplate {
  id               Int      @id @default(autoincrement())
  templateId       String   @unique @default(cuid())

  // Template details
  name             String
  description      String
  category         String   // pricing/headcount/customer/market/acquisition

  // Template structure (JSON)
  structure        String   // Questions to ask, parameters needed

  // Usage tracking
  usageCount       Int      @default(0)
  lastUsedAt       DateTime?

  // Metadata
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([templateId])
  @@index([category])
  @@index([usageCount])
}

// DM% Strategy Engine - Recommendations for Revenue Retention
model DMRecommendation {
  id                  Int      @id @default(autoincrement())
  recommendationId    String   @unique @default(cuid())

  // Account context
  accountName         String
  bu                  String

  // Recommendation details
  type                String   // pricing/product_enhancement/account_intervention/upsell/contract_restructure/competitive_defense/churn_prevention/portfolio_optimization
  priority            String   // critical/high/medium/low
  title               String
  description         String
  reasoning           String

  // Impact metrics
  arrImpact           Float    // Expected ARR impact in dollars
  dmImpact            Float    // Expected DM% change (percentage points)
  marginImpact        Float    // Expected margin impact (percentage points)
  confidenceLevel     Int      // 0-100 confidence score

  // Execution
  timeline            String   // immediate/short-term/medium-term/long-term
  ownerTeam           String   // CSM/Sales/Product/Engineering/Executive/Finance
  risk                String   // high/medium/low

  // Status tracking
  status              String   @default("pending") // pending/accepted/deferred/completed/rejected
  deferredReason      String?
  linkedActionItemId  String?  // Link to ActionItem if accepted

  // Timestamps
  createdAt           DateTime @default(now())
  acceptedAt          DateTime?
  completedAt         DateTime?

  @@index([recommendationId])
  @@index([accountName])
  @@index([bu])
  @@index([status])
  @@index([priority])
  @@index([type])
  @@index([createdAt])
}

// DM Strategy Analysis Run Tracking
model DMAnalysisRun {
  id                          Int      @id @default(autoincrement())
  runId                       String   @unique

  // Run details
  runDate                     DateTime @default(now())
  bu                          String?
  accountsAnalyzed            Int
  recommendationsGenerated    Int
  totalPotentialARR           Float
  totalPotentialDM            Float

  // Status
  status                      String   // running/completed/failed
  error                       String?

  // Timestamps
  completedAt                 DateTime?

  @@index([runId])
  @@index([runDate])
  @@index([status])
}

// Action Items created from accepted DM Recommendations
model ActionItem {
  id                    Int      @id @default(autoincrement())
  actionItemId          String   @unique @default(cuid())

  // Link to recommendation
  recommendationId      String

  // Assignment
  assignedTo            String   // Team or person responsible
  dueDate               DateTime
  priority              String   // critical/high/medium/low

  // Organization
  board                 String   // Board/project this belongs to
  notes                 String?  // Additional context

  // Status tracking
  status                String   @default("todo") // todo/in_progress/completed
  completedAt           DateTime?

  // Metadata
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([recommendationId])
  @@index([assignedTo])
  @@index([status])
  @@index([dueDate])
}
