<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scenario Lab | Skyvera Strategic Planning</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@anthropic-ai/sdk@0.20.0/dist/index.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600;700&family=DM+Sans:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --ink: #1a1a1a;
            --paper: #fafaf8;
            --accent: #c84b31;
            --secondary: #2d4263;
            --muted: #8b8b8b;
            --border: #e8e6e1;
            --highlight: #ecdbba;
            --success: #2d7a4f;
            --warning: #d97706;
            --critical: #c2410c;
            --scenario: #7c3aed;

            --cloudsense: #2d4263;
            --kandy: #e65100;
            --stl: #1976d2;
            --newnet: #388e3c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: linear-gradient(135deg, #0f1419 0%, #1a2332 50%, #0f1419 100%);
            color: var(--paper);
            line-height: 1.6;
            overflow-x: hidden;
        }

        h1, h2, h3 {
            font-family: 'Cormorant Garamond', serif;
            font-weight: 600;
            line-height: 1.2;
        }

        /* Geometric background pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                repeating-linear-gradient(45deg, transparent, transparent 100px, rgba(200, 75, 49, 0.02) 100px, rgba(200, 75, 49, 0.02) 102px),
                repeating-linear-gradient(-45deg, transparent, transparent 100px, rgba(45, 66, 99, 0.02) 100px, rgba(45, 66, 99, 0.02) 102px);
            pointer-events: none;
            z-index: 0;
        }

        /* Header */
        .header {
            position: relative;
            background: linear-gradient(135deg, var(--secondary) 0%, #1a2840 100%);
            padding: 2rem 3rem;
            border-bottom: 3px solid var(--accent);
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            z-index: 10;
        }

        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 300;
            letter-spacing: -0.02em;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header h1::before {
            content: '‚ö°';
            font-size: 2rem;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 3px;
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            box-shadow: 0 2px 8px rgba(200, 75, 49, 0.3);
        }

        .btn-primary:hover {
            background: #b33d1f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(200, 75, 49, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--paper);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Tab Bar */
        .tab-bar {
            position: relative;
            background: rgba(26, 35, 50, 0.9);
            backdrop-filter: blur(10px);
            padding: 0 3rem;
            border-bottom: 1px solid rgba(232, 230, 225, 0.1);
            z-index: 9;
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .tab {
            padding: 1.25rem 2rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--muted);
            position: relative;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .tab:hover {
            color: var(--paper);
            background: rgba(255, 255, 255, 0.05);
        }

        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
            background: rgba(200, 75, 49, 0.1);
        }

        .tab.baseline {
            color: var(--paper);
        }

        .tab.baseline.active {
            border-bottom-color: var(--paper);
        }

        .tab-badge {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: var(--scenario);
            color: white;
            font-size: 0.65rem;
            padding: 0.2rem 0.4rem;
            border-radius: 2px;
        }

        /* Main Content */
        .container {
            position: relative;
            max-width: 1800px;
            margin: 0 auto;
            padding: 3rem;
            z-index: 1;
        }

        .split-view-toggle {
            position: fixed;
            top: 50%;
            right: 420px;
            transform: translateY(-50%);
            z-index: 100;
            background: var(--secondary);
            padding: 1rem;
            border-radius: 3px 0 0 3px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid var(--accent);
            border-right: none;
        }

        .split-view-toggle:hover {
            background: var(--accent);
            transform: translateY(-50%) translateX(-5px);
        }

        .split-view-toggle span {
            writing-mode: vertical-rl;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-size: 0.75rem;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .metric-card {
            background: rgba(26, 35, 50, 0.95);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 4px;
            border: 1px solid rgba(232, 230, 225, 0.1);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            border-color: var(--accent);
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--accent) 0%, transparent 100%);
        }

        .metric-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--muted);
            font-weight: 700;
            margin-bottom: 0.75rem;
        }

        .metric-value {
            font-size: 2.5rem;
            font-family: 'Cormorant Garamond', serif;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--paper);
        }

        .metric-delta {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.8rem;
            border-radius: 2px;
            font-size: 0.85rem;
            font-weight: 700;
            letter-spacing: 0.05em;
        }

        .metric-delta.positive {
            background: rgba(45, 122, 79, 0.2);
            color: #4ade80;
            border: 1px solid rgba(74, 222, 128, 0.3);
        }

        .metric-delta.negative {
            background: rgba(194, 65, 12, 0.2);
            color: #fb923c;
            border: 1px solid rgba(251, 146, 60, 0.3);
        }

        .metric-delta::before {
            content: '‚ñ≤';
            font-size: 0.7rem;
        }

        .metric-delta.negative::before {
            content: '‚ñº';
        }

        /* Charts */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .chart-card {
            background: rgba(26, 35, 50, 0.95);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 4px;
            border: 1px solid rgba(232, 230, 225, 0.1);
        }

        .chart-card h3 {
            font-size: 1.25rem;
            margin-bottom: 1.5rem;
            color: var(--paper);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .chart-card h3::before {
            content: '';
            width: 4px;
            height: 24px;
            background: var(--accent);
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Chat Interface */
        .chat-widget {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 400px;
            max-height: 600px;
            background: rgba(26, 35, 50, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 8px;
            border: 2px solid var(--accent);
            box-shadow: 0 12px 48px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .chat-widget.collapsed {
            max-height: 60px;
        }

        .chat-header {
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, var(--accent) 0%, #b33d1f 100%);
            border-radius: 6px 6px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .chat-header h3 {
            font-size: 1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .chat-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .chat-widget.collapsed .chat-toggle {
            transform: rotate(180deg);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            max-height: 400px;
        }

        .chat-message {
            margin-bottom: 1rem;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-message.user {
            text-align: right;
        }

        .chat-bubble {
            display: inline-block;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            max-width: 80%;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .chat-message.user .chat-bubble {
            background: var(--accent);
            color: white;
        }

        .chat-message.assistant .chat-bubble {
            background: rgba(255, 255, 255, 0.1);
            color: var(--paper);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .chat-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .chat-action-btn {
            padding: 0.5rem 1rem;
            background: var(--scenario);
            color: white;
            border: none;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .chat-action-btn:hover {
            background: #6d28d9;
            transform: scale(1.05);
        }

        .chat-input-area {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-input {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            color: var(--paper);
            font-family: 'DM Sans', sans-serif;
            font-size: 0.9rem;
            resize: none;
        }

        .chat-input::placeholder {
            color: var(--muted);
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--accent);
            background: rgba(255, 255, 255, 0.15);
        }

        /* Settings Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: rgba(26, 35, 50, 0.98);
            border: 2px solid var(--accent);
            border-radius: 8px;
            padding: 3rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .modal-header h2 {
            font-size: 2rem;
            color: var(--paper);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--muted);
            font-size: 2rem;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .modal-close:hover {
            color: var(--accent);
        }

        .form-group {
            margin-bottom: 2rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--muted);
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            color: var(--paper);
            font-family: 'DM Sans', sans-serif;
            font-size: 1rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent);
            background: rgba(255, 255, 255, 0.15);
        }

        /* Comparison Table */
        .comparison-table {
            background: rgba(26, 35, 50, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 4px;
            border: 1px solid rgba(232, 230, 225, 0.1);
            overflow: hidden;
        }

        .comparison-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .comparison-table th {
            padding: 1rem 1.5rem;
            text-align: left;
            background: rgba(200, 75, 49, 0.1);
            border-bottom: 2px solid var(--accent);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.85rem;
        }

        .comparison-table td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .comparison-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #b33d1f;
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .metric-card {
            animation: fadeInUp 0.6s ease backwards;
        }

        .metric-card:nth-child(1) { animation-delay: 0.1s; }
        .metric-card:nth-child(2) { animation-delay: 0.2s; }
        .metric-card:nth-child(3) { animation-delay: 0.3s; }
        .metric-card:nth-child(4) { animation-delay: 0.4s; }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <h1>Scenario Lab</h1>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="openSettings()">‚öôÔ∏è Settings</button>
                <button class="btn btn-secondary" onclick="exportScenario()">üì• Export</button>
                <button class="btn btn-primary" onclick="window.location.href='analytics.html'">‚Üê Analytics Dashboard</button>
            </div>
        </div>
    </div>

    <!-- Tab Bar -->
    <div class="tab-bar">
        <div class="tab baseline active" onclick="switchTab('baseline')">
            üìä Baseline
        </div>
        <div class="tab" onclick="switchTab('scenario1')">
            Scenario 1
            <span class="tab-badge">NEW</span>
        </div>
        <div class="tab" onclick="switchTab('scenario2')" style="opacity: 0.5; cursor: not-allowed;">
            Scenario 2
        </div>
        <div class="tab" onclick="switchTab('scenario3')" style="opacity: 0.5; cursor: not-allowed;">
            Scenario 3
        </div>
        <button class="btn btn-secondary" style="margin-left: auto;" onclick="addScenario()">+ New Scenario</button>
    </div>

    <!-- Split View Toggle -->
    <div class="split-view-toggle" onclick="toggleSplitView()">
        <span>‚ö° Compare</span>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Metrics Dashboard -->
        <div class="dashboard-grid">
            <div class="metric-card">
                <div class="metric-label">Total ARR</div>
                <div class="metric-value" id="totalARR">Loading...</div>
                <div class="metric-delta positive" id="arrDelta" style="display: none;">
                    +$3.2M (+9.9%)
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Customer Count</div>
                <div class="metric-value" id="customerCount">Loading...</div>
                <div class="metric-delta negative" id="customerDelta" style="display: none;">
                    -1 (-0.6%)
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Avg ARR/Customer</div>
                <div class="metric-value" id="avgARR">Loading...</div>
                <div class="metric-delta positive" id="avgDelta" style="display: none;">
                    +$21.8K (+10.5%)
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Net Margin</div>
                <div class="metric-value" id="netMargin">62.5%</div>
                <div class="metric-delta positive" id="marginDelta" style="display: none;">
                    +2.1pp
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="chart-grid">
            <div class="chart-card">
                <h3>ARR by Business Unit</h3>
                <div class="chart-container">
                    <canvas id="buChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>Revenue Projection (12 Months)</h3>
                <div class="chart-container">
                    <canvas id="projectionChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>Top 10 Customers</h3>
                <div class="chart-container">
                    <canvas id="customersChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>Regional Distribution</h3>
                <div class="chart-container">
                    <canvas id="regionChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Comparison Table -->
        <div class="comparison-table">
            <table>
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Baseline</th>
                        <th>Scenario 1</th>
                        <th>Delta</th>
                    </tr>
                </thead>
                <tbody id="comparisonTableBody">
                    <tr>
                        <td><strong>Total ARR</strong></td>
                        <td id="comp-baseline-total">Loading...</td>
                        <td id="comp-arr">‚Äî</td>
                        <td id="comp-arr-delta">‚Äî</td>
                    </tr>
                    <tr>
                        <td><strong>CloudSense ARR</strong></td>
                        <td id="comp-baseline-cloudsense">Loading...</td>
                        <td id="comp-cloudsense">‚Äî</td>
                        <td id="comp-cloudsense-delta">‚Äî</td>
                    </tr>
                    <tr>
                        <td><strong>Kandy ARR</strong></td>
                        <td id="comp-baseline-kandy">Loading...</td>
                        <td id="comp-kandy">‚Äî</td>
                        <td id="comp-kandy-delta">‚Äî</td>
                    </tr>
                    <tr>
                        <td><strong>STL ARR</strong></td>
                        <td id="comp-baseline-stl">Loading...</td>
                        <td id="comp-stl">‚Äî</td>
                        <td id="comp-stl-delta">‚Äî</td>
                    </tr>
                    <tr>
                        <td><strong>NewNet ARR</strong></td>
                        <td id="comp-baseline-newnet">Loading...</td>
                        <td id="comp-newnet">‚Äî</td>
                        <td id="comp-newnet-delta">‚Äî</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Chat Widget -->
    <div class="chat-widget" id="chatWidget">
        <div class="chat-header" onclick="toggleChat()">
            <h3>üí¨ Scenario Chat</h3>
            <button class="chat-toggle">‚ñº</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="chat-message assistant">
                <div class="chat-bubble">
                    Welcome to Scenario Lab! Ask me anything like:
                    <ul style="margin-top: 0.5rem; padding-left: 1.5rem;">
                        <li>"What if EMIRCOM grows 3% monthly?"</li>
                        <li>"What if we double the price on Centrica?"</li>
                        <li>"What if we lose One Albania?"</li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="chat-input-area">
            <textarea class="chat-input" id="chatInput" rows="2" placeholder="Type your scenario question..."></textarea>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settings</h2>
                <button class="modal-close" onclick="closeSettings()">√ó</button>
            </div>
            <form>
                <div class="form-group">
                    <label for="apiKey">Claude API Key</label>
                    <input type="password" id="apiKey" placeholder="sk-ant-...">
                    <small style="color: var(--muted); margin-top: 0.5rem; display: block;">
                        Your API key is stored locally and never sent to our servers.
                    </small>
                </div>
                <div class="form-group">
                    <label for="defaultDuration">Default Scenario Duration (Months)</label>
                    <input type="number" id="defaultDuration" value="12" min="1" max="60">
                </div>
                <button type="button" class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
            </form>
        </div>
    </div>

    <script>
        // Real customer data from Excel
        // Real customer data from Excel "RR Input" sheet (ARR as of 11.30.2025)
        const customersDatabase = [
            { name: 'EMIRCOM', arr: 9.586, bu: 'Kandy', aliases: ['emircom'] },
            { name: 'NS Solutions', arr: 2.413, bu: 'NewNet', aliases: ['ns solutions corporation'] },
            { name: 'Telefonica UK', arr: 2.105, bu: 'CloudSense', aliases: ['telefonica united kingdom', 'telefonica uk limited'] },
            { name: 'HCL Technologies', arr: 2.083, bu: 'NewNet', aliases: ['hcl', 'hcl tech', 'hcl technologies uk'] },
            { name: 'Telstra', arr: 1.972, bu: 'CloudSense', aliases: ['telstra corp', 'telstra corporation'] },
            { name: 'Vodafone Netherlands', arr: 1.843, bu: 'CloudSense', aliases: ['vodafone nl', 'vodafone dutch'] },
            { name: 'AT&T', arr: 1.798, bu: 'Kandy', aliases: ['att', 'at&t services'] },
            { name: 'One Albania', arr: 1.621, bu: 'STL', aliases: ['one alb'] },
            { name: 'Spotify', arr: 1.587, bu: 'CloudSense', aliases: [] },
            { name: 'British Telecommunications', arr: 1.405, bu: 'CloudSense', aliases: ['bt', 'british telecom', 'bt plc'] },
            { name: 'TRANSCOM', arr: 1.236, bu: 'VoltDelta', aliases: [] },
            { name: 'Maxis', arr: 1.235, bu: 'CloudSense', aliases: ['maxis broadband'] },
            { name: 'Liquid Telecom', arr: 1.074, bu: 'CloudSense', aliases: ['liquid'] },
            { name: 'Centrica', arr: 1.054, bu: 'CloudSense', aliases: ['centrica services'] },
            { name: 'Abbott Laboratories', arr: 0.817, bu: 'CloudSense', aliases: ['abbott'] },
            { name: 'StarHub', arr: 0.750, bu: 'CloudSense', aliases: ['starhub ltd'] },
            { name: 'Elisa', arr: 0.724, bu: 'CloudSense', aliases: ['elisa oyj'] },
            { name: 'Advance Publications', arr: 0.659, bu: 'CloudSense', aliases: ['advance pub'] },
            { name: 'Virgin Media', arr: 0.656, bu: 'CloudSense', aliases: ['virgin media limited'] },
            { name: 'Foxtel', arr: 0.640, bu: 'CloudSense', aliases: ['foxtel management'] },
            { name: 'PostNL', arr: 0.576, bu: 'CloudSense', aliases: ['postnl holding'] },
            { name: 'Thryv Australia', arr: 0.568, bu: 'CloudSense', aliases: ['thryv'] },
            { name: 'A1 Telekom Austria', arr: 0.521, bu: 'CloudSense', aliases: ['a1 austria', 'a1 telekom'] },
            { name: 'Luminus', arr: 0.493, bu: 'CloudSense', aliases: ['luminus hasselt'] },
            { name: 'Vodafone GmbH', arr: 0.483, bu: 'NewNet', aliases: ['vodafone germany', 'vodafone de'] },
            { name: 'Telefonica Germany', arr: 0.460, bu: 'CloudSense', aliases: ['telefonica de', 'telefonica gmbh'] },
            { name: 'CoreSite', arr: 0.456, bu: 'CloudSense', aliases: [] },
            { name: 'DPLAY', arr: 0.428, bu: 'CloudSense', aliases: ['dplay entertainment'] },
            { name: 'Informa UK', arr: 0.412, bu: 'CloudSense', aliases: [] },
            { name: 'Proximus', arr: 0.400, bu: 'CloudSense', aliases: ['proximus nv'] },
            { name: 'DPG Media', arr: 0.359, bu: 'CloudSense', aliases: ['dpg media bv'] },
            { name: 'Masergy Communications', arr: 0.350, bu: 'CloudSense', aliases: ['masergy'] },
            { name: 'Commverge Solutions', arr: 0.346, bu: 'STL', aliases: ['commverge philippines'] },
            { name: 'Hawaiian Telcom', arr: 0.335, bu: 'CloudSense', aliases: ['hawaiian telcom communications'] },
            { name: 'MasterCard', arr: 0.323, bu: 'CloudSense', aliases: ['mastercard worldwide'] },
            { name: 'Konnektio', arr: 0.323, bu: 'VoltDelta', aliases: ['konnektio oy'] },
            { name: 'Telenet', arr: 0.302, bu: 'CloudSense', aliases: ['telenet bv'] },
            { name: 'Interxion', arr: 0.296, bu: 'CloudSense', aliases: ['interxion headquarters'] },
            { name: 'NBN Co', arr: 0.294, bu: 'CloudSense', aliases: ['nbn', 'nbn co ltd'] },
            { name: 'PT Supra Primatama', arr: 0.275, bu: 'STL', aliases: [] },
            { name: 'Sun Corporation', arr: 0.272, bu: 'Mobilogy', aliases: [] },
            { name: 'PropertyGuru', arr: 0.262, bu: 'CloudSense', aliases: [] },
            { name: 'Momentum Energy', arr: 0.241, bu: 'CloudSense', aliases: [] },
            { name: 'Nokia Solutions', arr: 0.216, bu: 'NewNet', aliases: ['nokia solutions and networks'] },
            { name: 'Telecom Argentina', arr: 0.200, bu: 'NewNet', aliases: [] }
        ];

        // Calculate baseline data from customer database
        const baselineData = {
            totalARR: customersDatabase.reduce((sum, c) => sum + c.arr, 0),
            customerCount: customersDatabase.length,
            avgARR: customersDatabase.reduce((sum, c) => sum + c.arr, 0) / customersDatabase.length,
            netMargin: 0.625,
            buData: {
                'CloudSense': customersDatabase.filter(c => c.bu === 'CloudSense').reduce((sum, c) => sum + c.arr, 0),
                'Kandy': customersDatabase.filter(c => c.bu === 'Kandy').reduce((sum, c) => sum + c.arr, 0),
                'STL': customersDatabase.filter(c => c.bu === 'STL').reduce((sum, c) => sum + c.arr, 0),
                'NewNet': customersDatabase.filter(c => c.bu === 'NewNet').reduce((sum, c) => sum + c.arr, 0)
            },
            topCustomers: customersDatabase.slice(0, 10),
            regions: {
                'Americas': 32,
                'EMEA': 120,
                'APAC': 48
            }
        };

        // Customer lookup helper with alias support
        function findCustomer(name) {
            const searchName = name.toLowerCase().trim();

            // Try exact or partial name match first
            let customer = customersDatabase.find(c =>
                c.name.toLowerCase() === searchName ||
                c.name.toLowerCase().includes(searchName) ||
                searchName.includes(c.name.toLowerCase())
            );

            // Try aliases if no match
            if (!customer) {
                customer = customersDatabase.find(c =>
                    c.aliases && c.aliases.some(alias =>
                        alias.toLowerCase() === searchName ||
                        alias.toLowerCase().includes(searchName) ||
                        searchName.includes(alias.toLowerCase())
                    )
                );
            }

            // Log for debugging
            if (!customer) {
                console.log(`Customer not found: "${name}". Available: ${customersDatabase.map(c => c.name).join(', ')}`);
            } else {
                console.log(`Customer found: "${name}" -> ${customer.name} (ARR: $${customer.arr}M)`);
            }

            return customer;
        }

        let currentScenario = null;
        let charts = {};

        // Scenario calculation engine
        class ScenarioEngine {
            // Revenue growth over time
            calculateGrowth(baseline, rate, months) {
                let current = baseline;
                const deltas = {};
                const monthlyValues = [];

                for (let i = 1; i <= months; i++) {
                    current = baseline * Math.pow(1 + rate, i);
                    deltas[`month_${i}`] = current - baseline;
                    monthlyValues.push(current);
                }

                return {
                    finalValue: current,
                    totalDelta: current - baseline,
                    deltas: deltas,
                    monthlyValues: monthlyValues
                };
            }

            // Pricing impact with churn risk
            calculatePricing(baselineARR, multiplier) {
                const newARR = baselineARR * multiplier;
                const churnRisk = multiplier > 1.5 ? 0.3 : multiplier < 0.8 ? 0.4 : 0.1;

                return {
                    arrDelta: newARR - baselineARR,
                    newARR: newARR,
                    priceMultiplier: multiplier,
                    churnRisk: churnRisk,
                    expectedARR: newARR * (1 - churnRisk) // Account for churn
                };
            }

            // Customer churn impact
            calculateChurn(customerARR, totalARR) {
                return {
                    arrDelta: -customerARR,
                    percentOfTotal: (customerARR / totalARR) * 100,
                    newTotalARR: totalARR - customerARR
                };
            }
        }

        const scenarioEngine = new ScenarioEngine();

        // Update baseline metrics display
        function updateBaselineDisplay() {
            document.getElementById('totalARR').textContent = `$${baselineData.totalARR.toFixed(1)}M`;
            document.getElementById('customerCount').textContent = baselineData.customerCount;
            document.getElementById('avgARR').textContent = `$${baselineData.avgARR.toFixed(1)}M`;
            document.getElementById('netMargin').textContent = `${(baselineData.netMargin * 100).toFixed(1)}%`;

            // Update comparison table baseline column
            document.getElementById('comp-baseline-total').textContent = `$${baselineData.totalARR.toFixed(1)}M`;
            document.getElementById('comp-baseline-cloudsense').textContent = `$${baselineData.buData.CloudSense.toFixed(1)}M`;
            document.getElementById('comp-baseline-kandy').textContent = `$${baselineData.buData.Kandy.toFixed(1)}M`;
            document.getElementById('comp-baseline-stl').textContent = `$${baselineData.buData.STL.toFixed(1)}M`;
            document.getElementById('comp-baseline-newnet').textContent = `$${baselineData.buData.NewNet.toFixed(1)}M`;
        }

        // Initialize charts
        function initCharts() {
            // BU Chart
            const buCtx = document.getElementById('buChart').getContext('2d');
            charts.bu = new Chart(buCtx, {
                type: 'bar',
                data: {
                    labels: ['CloudSense', 'Kandy', 'STL', 'NewNet'],
                    datasets: [{
                        label: 'ARR ($M)',
                        data: [
                            baselineData.buData.CloudSense,
                            baselineData.buData.Kandy,
                            baselineData.buData.STL,
                            baselineData.buData.NewNet
                        ],
                        backgroundColor: [
                            'rgba(45, 66, 99, 0.8)',
                            'rgba(230, 81, 0, 0.8)',
                            'rgba(25, 118, 210, 0.8)',
                            'rgba(56, 142, 60, 0.8)'
                        ],
                        borderColor: [
                            '#2d4263',
                            '#e65100',
                            '#1976d2',
                            '#388e3c'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#8b8b8b' },
                            grid: { color: 'rgba(232, 230, 225, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#fafaf8' },
                            grid: { display: false }
                        }
                    }
                }
            });

            // Projection Chart
            const projCtx = document.getElementById('projectionChart').getContext('2d');
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const baselineProjection = Array(12).fill(baselineData.totalARR);

            charts.projection = new Chart(projCtx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Baseline',
                        data: baselineProjection,
                        borderColor: '#fafaf8',
                        backgroundColor: 'rgba(250, 250, 248, 0.1)',
                        borderWidth: 2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: { color: '#fafaf8' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: { color: '#8b8b8b' },
                            grid: { color: 'rgba(232, 230, 225, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#8b8b8b' },
                            grid: { display: false }
                        }
                    }
                }
            });

            // Customers Chart
            const custCtx = document.getElementById('customersChart').getContext('2d');
            charts.customers = new Chart(custCtx, {
                type: 'bar',
                data: {
                    labels: baselineData.topCustomers.map(c => c.name),
                    datasets: [{
                        label: 'ARR ($M)',
                        data: baselineData.topCustomers.map(c => c.arr),
                        backgroundColor: 'rgba(200, 75, 49, 0.8)',
                        borderColor: '#c84b31',
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { color: '#8b8b8b' },
                            grid: { color: 'rgba(232, 230, 225, 0.1)' }
                        },
                        y: {
                            ticks: { color: '#fafaf8' },
                            grid: { display: false }
                        }
                    }
                }
            });

            // Region Chart
            const regionCtx = document.getElementById('regionChart').getContext('2d');
            charts.region = new Chart(regionCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Americas', 'EMEA', 'APAC'],
                    datasets: [{
                        data: [
                            baselineData.regions.Americas,
                            baselineData.regions.EMEA,
                            baselineData.regions.APAC
                        ],
                        backgroundColor: [
                            'rgba(200, 75, 49, 0.8)',
                            'rgba(45, 66, 99, 0.8)',
                            'rgba(56, 142, 60, 0.8)'
                        ],
                        borderColor: ['#c84b31', '#2d4263', '#388e3c'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#fafaf8', padding: 15 }
                        }
                    }
                }
            });
        }

        // Chat functionality
        function toggleChat() {
            document.getElementById('chatWidget').classList.toggle('collapsed');
        }

        document.getElementById('chatInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            // Add user message
            addChatMessage(message, 'user');
            input.value = '';

            // Show typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message assistant';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = '<div class="chat-bubble">Analyzing scenario...</div>';
            document.getElementById('chatMessages').appendChild(typingDiv);

            try {
                await processScenarioQuery(message);
            } catch (error) {
                console.error('Error processing scenario:', error);
                addChatMessage(
                    `Error: ${error.message}. Please check your API key in Settings.`,
                    'assistant'
                );
            } finally {
                // Remove typing indicator
                const indicator = document.getElementById('typing-indicator');
                if (indicator) indicator.remove();
            }
        }

        function addChatMessage(text, sender) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;

            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble';
            bubble.textContent = text;

            messageDiv.appendChild(bubble);

            if (sender === 'assistant') {
                const actions = document.createElement('div');
                actions.className = 'chat-actions';
                actions.innerHTML = `
                    <button class="chat-action-btn" onclick="applyScenario()">üìä View Scenario</button>
                    <button class="chat-action-btn" onclick="saveScenario()">üíæ Save</button>
                `;
                messageDiv.appendChild(actions);
            }

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        async function processScenarioQuery(query) {
            // Get API key from localStorage
            const apiKey = localStorage.getItem('claude_api_key');

            // Fallback to pattern matching if no API key
            if (!apiKey) {
                processScenarioWithPatternMatching(query);
                return;
            }

            try {
                // Get all customer names for the prompt
                const customerNames = customersDatabase.map(c => c.name).join(', ');

                // Call Claude API to parse scenario
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-3-5-sonnet-20241022',
                        max_tokens: 1024,
                        system: `You are a financial scenario parser for Skyvera. Convert user queries into structured JSON scenarios.

Output ONLY valid JSON in this format:
{
  "type": "revenue_growth" | "pricing" | "churn" | "multi",
  "parameters": {
    "customer": "CUSTOMER_NAME",
    "action": "growth" | "decline" | "price_change" | "churn" | "retain",
    "value": 0.03,
    "duration": 12,
    "isPercentage": true
  },
  "explanation": "Brief explanation of the scenario"
}

Examples:
- "what if EMIRCOM grows by 3% per month" ‚Üí {"type":"revenue_growth","parameters":{"customer":"EMIRCOM","action":"growth","value":0.03,"duration":12,"isPercentage":true},"explanation":"EMIRCOM growing 3% monthly for 12 months"}
- "what if we double the price on Centrica" ‚Üí {"type":"pricing","parameters":{"customer":"Centrica","action":"price_change","value":2.0,"isPercentage":false},"explanation":"Doubling price on Centrica"}
- "what if we lose One Albania" ‚Üí {"type":"churn","parameters":{"customer":"One Albania","action":"churn"},"explanation":"Customer churn: One Albania"}

Available customers: ${customerNames}
Available business units: CloudSense, Kandy, STL, NewNet`,
                        messages: [{
                            role: 'user',
                            content: query
                        }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    console.error('API Response:', errorData);
                    throw new Error(`API error: ${response.status} - ${errorData.substring(0, 100)}`);
                }

                const data = await response.json();
                const content = data.content[0].text;

                // Parse JSON response
                const scenarioData = JSON.parse(content);

                // Process the structured scenario
                processStructuredScenario(scenarioData);

            } catch (error) {
                console.error('Claude API error:', error);

                // Show detailed error to user if it's a CORS or auth issue
                if (error.message.includes('CORS') || error.message.includes('401') || error.message.includes('403')) {
                    addChatMessage(
                        `‚ö†Ô∏è API Error: ${error.message.includes('CORS') ? 'Browser security (CORS) prevents direct API calls. Using pattern matching fallback.' : 'API key authentication failed. Please check your API key in Settings.'}`,
                        'assistant'
                    );
                }

                // Fallback to pattern matching
                processScenarioWithPatternMatching(query);
            }
        }

        function processScenarioWithPatternMatching(query) {
            // Fallback pattern matching when API key not available
            const lowerQuery = query.toLowerCase();

            // Try to find customer name in query
            let foundCustomer = null;
            for (const customer of customersDatabase) {
                if (lowerQuery.includes(customer.name.toLowerCase())) {
                    foundCustomer = customer;
                    break;
                }
                // Check aliases
                if (customer.aliases) {
                    for (const alias of customer.aliases) {
                        if (lowerQuery.includes(alias.toLowerCase())) {
                            foundCustomer = customer;
                            break;
                        }
                    }
                }
                if (foundCustomer) break;
            }

            // If no customer found, try harder with multi-word matching
            if (!foundCustomer) {
                // Try two-word combinations
                const words = query.toLowerCase().split(/\s+/);
                for (let i = 0; i < words.length - 1; i++) {
                    const twoWords = words[i] + ' ' + words[i+1];
                    const threeWords = i < words.length - 2 ? words[i] + ' ' + words[i+1] + ' ' + words[i+2] : null;

                    // Try two-word combination
                    const match = findCustomer(twoWords);
                    if (match) {
                        foundCustomer = match;
                        console.log('Found via two-word match:', twoWords, '->', match.name);
                        break;
                    }

                    // Try three-word combination
                    if (threeWords) {
                        const match3 = findCustomer(threeWords);
                        if (match3) {
                            foundCustomer = match3;
                            console.log('Found via three-word match:', threeWords, '->', match3.name);
                            break;
                        }
                    }
                }
            }

            // Last resort: try individual words
            if (!foundCustomer) {
                const words = query.split(/\s+/);
                for (const word of words) {
                    if (word.length < 3) continue; // Skip short words
                    const match = findCustomer(word);
                    if (match) {
                        foundCustomer = match;
                        console.log('Found via single word:', word, '->', match.name);
                        break;
                    }
                }
            }

            console.log('Pattern matching result:', { query, foundCustomer: foundCustomer ? foundCustomer.name : 'NONE' });

            // Growth scenario
            if ((lowerQuery.includes('grow') || lowerQuery.includes('increase')) && foundCustomer) {
                const match = lowerQuery.match(/(\d+(?:\.\d+)?)%/);
                const growthRate = match ? parseFloat(match[1]) : 3;
                const months = 12;

                const baselineARR = foundCustomer.arr;
                const finalValue = baselineARR * Math.pow(1 + growthRate/100, months);
                const delta = finalValue - baselineARR;

                addChatMessage(
                    `I'll model ${foundCustomer.name} growing ${growthRate}% monthly for ${months} months. This would increase from $${baselineARR.toFixed(1)}M to $${finalValue.toFixed(1)}M ARR (+${((delta/baselineARR)*100).toFixed(1)}%).`,
                    'assistant'
                );

                currentScenario = {
                    type: 'growth',
                    customer: foundCustomer.name,
                    customerData: foundCustomer,
                    baselineARR: baselineARR,
                    rate: growthRate / 100,
                    months: months
                };
            }
            // Pricing scenario
            else if ((lowerQuery.includes('price') || lowerQuery.includes('double') || lowerQuery.includes('half')) && foundCustomer) {
                const multiplier = lowerQuery.includes('double') ? 2.0 :
                                  lowerQuery.includes('half') ? 0.5 : 1.5;

                const currentARR = foundCustomer.arr;
                const newARR = currentARR * multiplier;
                const churnRisk = multiplier > 1.5 ? 30 : multiplier < 0.8 ? 40 : 10;

                addChatMessage(
                    `I'll model ${multiplier > 1 ? 'increasing' : 'decreasing'} prices on ${foundCustomer.name} by ${((multiplier - 1) * 100).toFixed(0)}%. Current ARR: $${currentARR.toFixed(2)}M ‚Üí New ARR: $${newARR.toFixed(2)}M. ${multiplier > 1.5 ? `Warning: ${churnRisk}% churn risk.` : ''}`,
                    'assistant'
                );

                currentScenario = {
                    type: 'pricing',
                    customer: foundCustomer.name,
                    customerData: foundCustomer,
                    baselineARR: currentARR,
                    multiplier: multiplier,
                    churnRisk: churnRisk
                };
            }
            // Churn scenario
            else if ((lowerQuery.includes('lose') || lowerQuery.includes('churn')) && foundCustomer) {
                const customerARR = foundCustomer.arr;
                const impactPercent = ((customerARR / baselineData.totalARR) * 100).toFixed(1);

                addChatMessage(
                    `I'll model losing ${foundCustomer.name}. ARR impact: -$${customerARR.toFixed(1)}M (-${impactPercent}% of total company ARR).`,
                    'assistant'
                );

                currentScenario = {
                    type: 'churn',
                    customer: foundCustomer.name,
                    customerData: foundCustomer,
                    arr: customerARR
                };
            } else {
                // Show helpful message with available customers
                const customerList = customersDatabase.slice(0, 10).map(c => c.name).join(', ');
                addChatMessage(
                    `I couldn't find a customer in your query. Try mentioning a specific customer like: "${customersDatabase[0].name}", "${customersDatabase[1].name}", or "${customersDatabase[2].name}". Examples: "What if ${customersDatabase[0].name} grows 3% monthly?" or "What if we lose ${customersDatabase[2].name}?"`,
                    'assistant'
                );
            }
        }

        function processStructuredScenario(scenarioData) {
            // Process Claude's structured response
            const { type, parameters, explanation } = scenarioData;

            if (type === 'revenue_growth') {
                const { customer, value, duration } = parameters;
                const growthRate = value;
                const months = duration || 12;

                // Find the actual customer data
                const customerData = findCustomer(customer);
                if (!customerData) {
                    addChatMessage(
                        `‚ö†Ô∏è Customer "${customer}" not found in database. Please use a valid customer name.`,
                        'assistant'
                    );
                    return;
                }

                const baselineARR = customerData.arr;
                const finalValue = baselineARR * Math.pow(1 + growthRate, months);
                const delta = finalValue - baselineARR;
                const percentChange = ((Math.pow(1 + growthRate, months) - 1) * 100).toFixed(1);

                addChatMessage(
                    `I'll model ${customerData.name} growing ${(growthRate * 100).toFixed(1)}% monthly for ${months} months. This would increase from $${baselineARR.toFixed(1)}M to $${finalValue.toFixed(1)}M ARR (+${percentChange}%). Total company impact: +$${delta.toFixed(1)}M (+${((delta/baselineData.totalARR)*100).toFixed(1)}%).`,
                    'assistant'
                );

                currentScenario = {
                    type: 'growth',
                    customer: customerData.name,
                    customerData: customerData,
                    baselineARR: baselineARR,
                    rate: growthRate,
                    months: months
                };

            } else if (type === 'pricing') {
                const { customer, value } = parameters;

                // Find the actual customer data
                const customerData = findCustomer(customer);
                if (!customerData) {
                    addChatMessage(
                        `‚ö†Ô∏è Customer "${customer}" not found in database. Please use a valid customer name.`,
                        'assistant'
                    );
                    return;
                }

                const currentARR = customerData.arr;
                const newARR = currentARR * value;
                const churnRisk = value > 1.5 ? 30 : value < 0.8 ? 40 : 10;
                const expectedARR = newARR * (1 - churnRisk / 100);
                const netDelta = expectedARR - currentARR;

                addChatMessage(
                    `I'll model ${value > 1 ? 'increasing' : 'decreasing'} prices on ${customerData.name} by ${((value - 1) * 100).toFixed(0)}%. Current ARR: $${currentARR.toFixed(2)}M ‚Üí Theoretical ARR: $${newARR.toFixed(2)}M. ${value > 1.5 ? `Warning: ${churnRisk}% churn risk assumed. Expected ARR: $${expectedARR.toFixed(2)}M (net impact: ${netDelta >= 0 ? '+' : ''}$${netDelta.toFixed(2)}M).` : ''}`,
                    'assistant'
                );

                currentScenario = {
                    type: 'pricing',
                    customer: customerData.name,
                    customerData: customerData,
                    baselineARR: currentARR,
                    multiplier: value,
                    churnRisk: churnRisk
                };

            } else if (type === 'churn') {
                const { customer } = parameters;

                // Find the actual customer data
                const customerData = findCustomer(customer);
                if (!customerData) {
                    addChatMessage(
                        `‚ö†Ô∏è Customer "${customer}" not found in database. Please use a valid customer name.`,
                        'assistant'
                    );
                    return;
                }

                const customerARR = customerData.arr;
                const impactPercent = ((customerARR / baselineData.totalARR) * 100).toFixed(1);

                addChatMessage(
                    `I'll model losing ${customerData.name}. ARR impact: -$${customerARR.toFixed(1)}M (-${impactPercent}% of total company ARR). This is a ${customerData.bu} customer.`,
                    'assistant'
                );

                currentScenario = {
                    type: 'churn',
                    customer: customerData.name,
                    customerData: customerData,
                    arr: customerARR
                };
            } else {
                addChatMessage(
                    explanation || 'I processed your scenario. Click "View Scenario" to see the impact.',
                    'assistant'
                );
            }
        }

        function applyScenario() {
            if (!currentScenario) {
                console.log('applyScenario: No current scenario');
                return;
            }

            console.log('applyScenario called:', currentScenario);

            if (currentScenario.type === 'growth') {
                // Handle revenue growth scenarios
                const baseline = currentScenario.baselineARR;
                console.log('Growth scenario:', {
                    customer: currentScenario.customer,
                    baseline,
                    rate: currentScenario.rate,
                    months: currentScenario.months,
                    baselineTotal: baselineData.totalARR
                });

                const result = scenarioEngine.calculateGrowth(
                    baseline,
                    currentScenario.rate,
                    currentScenario.months
                );

                const delta = result.totalDelta;
                const newTotal = baselineData.totalARR + delta;

                console.log('Growth calculation result:', {
                    finalValue: result.finalValue,
                    delta,
                    newTotal,
                    percentChange: ((delta/baselineData.totalARR)*100).toFixed(1)
                });

                // Update metric displays
                document.getElementById('totalARR').textContent = `$${newTotal.toFixed(1)}M`;
                document.getElementById('arrDelta').style.display = 'inline-flex';
                document.getElementById('arrDelta').className = 'metric-delta positive';
                document.getElementById('arrDelta').textContent = `+$${delta.toFixed(1)}M (+${((delta/baselineData.totalARR)*100).toFixed(1)}%)`;

                // Update BU chart - find which BU this customer belongs to
                const customerBU = currentScenario.customerData.bu;
                const buIndex = ['CloudSense', 'Kandy', 'STL', 'NewNet'].indexOf(customerBU);
                const buBaseline = baselineData.buData[customerBU];

                if (buIndex >= 0) {
                    const newBUValue = buBaseline + delta;
                    console.log('BU update:', { bu: customerBU, baseline: buBaseline, delta, newValue: newBUValue });
                    charts.bu.data.datasets[0].data[buIndex] = newBUValue;
                    charts.bu.update();
                }

                // Update projection chart with growth curve
                const projectionData = result.monthlyValues.map(val =>
                    baselineData.totalARR + (val - baseline)
                );

                // Remove old scenario dataset if exists
                charts.projection.data.datasets = charts.projection.data.datasets.filter(
                    ds => ds.label === 'Baseline'
                );

                charts.projection.data.datasets.push({
                    label: 'Scenario 1',
                    data: projectionData,
                    borderColor: '#7c3aed',
                    backgroundColor: 'rgba(124, 58, 237, 0.1)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: true
                });
                charts.projection.update();

                // Update comparison table
                document.getElementById('comp-arr').textContent = `$${newTotal.toFixed(1)}M`;
                const buCompId = `comp-${customerBU.toLowerCase()}`;
                if (document.getElementById(buCompId)) {
                    document.getElementById(buCompId).textContent = `$${(buBaseline + delta).toFixed(1)}M`;
                    document.getElementById(`${buCompId}-delta`).innerHTML = `<span class="metric-delta positive">+$${delta.toFixed(1)}M</span>`;
                }

            } else if (currentScenario.type === 'pricing') {
                // Handle pricing change scenarios
                const baselineARR = currentScenario.baselineARR;
                const result = scenarioEngine.calculatePricing(
                    baselineARR,
                    currentScenario.multiplier
                );

                const netDelta = result.expectedARR - baselineARR;
                const newTotal = baselineData.totalARR + netDelta;

                // Update metric displays
                document.getElementById('totalARR').textContent = `$${newTotal.toFixed(1)}M`;
                document.getElementById('arrDelta').style.display = 'inline-flex';
                document.getElementById('arrDelta').className = netDelta >= 0 ? 'metric-delta positive' : 'metric-delta negative';
                document.getElementById('arrDelta').textContent = `${netDelta >= 0 ? '+' : ''}$${Math.abs(netDelta).toFixed(2)}M (${((netDelta/baselineData.totalARR)*100).toFixed(1)}%)`;

                // Add churn risk warning
                if (result.churnRisk > 0.2) {
                    addChatMessage(
                        `‚ö†Ô∏è High churn risk (${(result.churnRisk * 100).toFixed(0)}%) accounted for. Expected ARR: $${result.expectedARR.toFixed(2)}M vs. theoretical $${result.newARR.toFixed(2)}M`,
                        'assistant'
                    );
                }

            } else if (currentScenario.type === 'churn') {
                // Handle customer churn scenarios
                const result = scenarioEngine.calculateChurn(
                    currentScenario.arr,
                    baselineData.totalARR
                );

                // Update metric displays
                document.getElementById('totalARR').textContent = `$${result.newTotalARR.toFixed(1)}M`;
                document.getElementById('arrDelta').style.display = 'inline-flex';
                document.getElementById('arrDelta').className = 'metric-delta negative';
                document.getElementById('arrDelta').textContent = `-$${currentScenario.arr.toFixed(1)}M (-${result.percentOfTotal.toFixed(1)}%)`;

                document.getElementById('customerCount').textContent = (baselineData.customerCount - 1).toString();
                document.getElementById('customerDelta').style.display = 'inline-flex';
                document.getElementById('customerDelta').className = 'metric-delta negative';
                document.getElementById('customerDelta').textContent = '-1 (-0.6%)';
            }
        }

        function saveScenario() {
            alert('Scenario saved to localStorage!');
        }

        function switchTab(tab) {
            // Update tab styling
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // In production, load different scenario data
        }

        function addScenario() {
            alert('New scenario tab will be created');
        }

        function toggleSplitView() {
            alert('Split view mode will show baseline and scenario side-by-side');
        }

        function openSettings() {
            loadSettings(); // Load current settings
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function saveSettings() {
            const apiKey = document.getElementById('apiKey').value;
            const defaultDuration = document.getElementById('defaultDuration').value;

            if (apiKey) {
                localStorage.setItem('claude_api_key', apiKey);
            }
            if (defaultDuration) {
                localStorage.setItem('default_duration', defaultDuration);
            }

            alert('Settings saved! Your API key is stored securely in your browser.');
            closeSettings();
        }

        function loadSettings() {
            // Load saved settings on page load
            const apiKey = localStorage.getItem('claude_api_key');
            const defaultDuration = localStorage.getItem('default_duration');

            if (apiKey) {
                document.getElementById('apiKey').value = apiKey;
            }
            if (defaultDuration) {
                document.getElementById('defaultDuration').value = defaultDuration;
            }
        }

        function exportScenario() {
            const data = {
                baseline: baselineData,
                scenario: currentScenario,
                exported: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `scenario-${Date.now()}.json`;
            a.click();
        }

        // Initialize on load
        window.addEventListener('load', () => {
            updateBaselineDisplay();
            initCharts();
            loadSettings();

            // Show API key setup message if not configured
            if (!localStorage.getItem('claude_api_key')) {
                setTimeout(() => {
                    addChatMessage(
                        `üí° Tip: Configure your Claude API key in Settings (‚öôÔ∏è) to enable AI-powered scenario parsing. Without it, I'll use pattern matching.

Available customers: ${customersDatabase.slice(0, 5).map(c => c.name).join(', ')}, and ${customersDatabase.length - 5} more.`,
                        'assistant'
                    );
                }, 500);
            }
        });
    </script>
</body>
</html>
